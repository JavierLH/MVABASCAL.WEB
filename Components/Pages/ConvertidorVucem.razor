@page "/herramientas/convertidor-vucem"
@inject HttpClient Http
@inject IJSRuntime JS
@inject SweetAlertService Swal
@using System.Net.Http.Headers

<div class="container mt-4">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-dark text-white py-3">
            <h5 class="mb-0 fw-bold"><i class="bi bi-file-earmark-pdf-fill"></i> Optimizador VUCEM (300 DPI)</h5>
            <small class="text-white-50">Convierte, limpia y comprime documentos para Ventanilla Única</small>
        </div>

        <div class="card-body bg-light">
            @* Tarjeta de Información *@
            <div class="alert alert-primary shadow-sm border-0 d-flex align-items-center mb-4" role="alert">
                <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                <div>
                    <strong>¿Qué hace esta herramienta?</strong>
                    <ul class="mb-0 small mt-1 ps-3">
                        <li>Convierte cualquier PDF a <strong>Escala de Grises</strong> (8-bits).</li>
                        <li>Ajusta la resolución a <strong>300 DPI</strong> (o 200/150 DPI si es necesario por peso).</li>
                        <li>Elimina automáticamente <strong>hojas en blanco</strong>.</li>
                        <li>Garantiza un peso menor a <strong>3 MB</strong>.</li>
                        <li>Elimina scripts, contraseñas y formularios interactivos.</li>
                    </ul>
                </div>
            </div>

            @* Área de Carga *@
            <div class="card border-primary border-2 border-dashed shadow-sm text-center py-5" style="border-style: dashed !important; background-color: #f8f9fa;">
                <div class="card-body">
                    <i class="bi bi-cloud-arrow-up-fill text-primary display-4 mb-3"></i>
                    <h5 class="fw-bold text-secondary">Selecciona tu archivo PDF</h5>
                    <p class="text-muted small mb-4">Máximo soportado para subida: 30 MB (El sistema lo reducirá a 3 MB)</p>
                    
                    <div class="d-flex justify-content-center">
                        <InputFile OnChange="SubirArchivo" class="form-control w-50" accept=".pdf" disabled="@procesando" />
                    </div>
                </div>
            </div>

            @* Indicador de Progreso *@
            @if (procesando)
            {
                <div class="mt-4 text-center">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Procesando...</span>
                    </div>
                    <h5 class="mt-3 fw-bold text-primary">Optimizando documento...</h5>
                    <p class="text-muted small">Esto puede tardar unos segundos si el archivo es muy pesado o tiene muchas páginas.</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private bool procesando = false;

    private async Task SubirArchivo(InputFileChangeEventArgs e)
    {
        var archivo = e.File;
        if (archivo == null) return;

        // Validar extensión
        if (!archivo.Name.ToLower().EndsWith(".pdf"))
        {
            await MostrarToast("Archivo Incorrecto: Solo se permiten archivos PDF.", SweetAlertIcon.Warning);
            return;
        }

        // Límite de subida (30MB para dar margen al servidor de procesar)
        long maxFileSize = 1024 * 1024 * 30;

        try
        {
            procesando = true;
            StateHasChanged(); // Forzar renderizado para mostrar spinner

            using var content = new MultipartFormDataContent();

            // Leemos el archivo del cliente
            // Nota: maxFileSize es importante aquí para que Blazor no rechace el archivo antes de enviarlo
            var fileContent = new StreamContent(archivo.OpenReadStream(maxFileSize));
            fileContent.Headers.ContentType = new MediaTypeHeaderValue("application/pdf");
            content.Add(fileContent, "archivo", archivo.Name);

            // Enviamos al API
            var response = await Http.PostAsync("api/Utilidades/convertir-vucem", content);

            if (response.IsSuccessStatusCode)
            {
                var fileBytes = await response.Content.ReadAsByteArrayAsync();

                // Nombre sugerido para la descarga
                var nombreDescarga = Path.GetFileNameWithoutExtension(archivo.Name) + "_VUCEM.pdf";

                // Descarga JS
                await JS.InvokeVoidAsync("descargarArchivoDesdeBytes", nombreDescarga, Convert.ToBase64String(fileBytes));

                await MostrarToast("¡Listo! El archivo se ha optimizado y descargado correctamente.", SweetAlertIcon.Success);
               
            }
            else
            {
                // Leemos el error que nos mandó el Backend (ej. "No se pudo reducir...")
                var msjError = await response.Content.ReadAsStringAsync();
                await MostrarToast("Error al procesar: "+msjError, SweetAlertIcon.Error);
            }
        }
        catch (Exception ex)
        {
            await MostrarToast("Error de Conexión: No se pudo enviar el archivo: " +ex.Message, SweetAlertIcon.Error);
        }
        finally
        {
            procesando = false;
        }
    }

    private async Task MostrarToast(string mensaje, SweetAlertIcon icono)
    {
        await Swal.FireAsync(new SweetAlertOptions
        {
            Toast = true,
            Position = SweetAlertPosition.TopEnd, // Arriba a la derecha
            ShowConfirmButton = false,
            Timer = 3000,
            Icon = icono,
            Title = mensaje
        });
    }
}