@page "/clientes"
@inject HttpClient Http
@inject SweetAlertService Swal
@using SistemaAduanero.Shared.DTOs
@attribute [Authorize] 
<div class="container-fluid mt-4">
    @* === SECCIÓN 1: CABECERA Y BUSCADOR === *@
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-people-fill"></i>
                <h6 class="mb-0 fw-bold text-uppercase">Catálogo de Clientes</h6>
            </div>
            <button class="btn btn-light btn-sm fw-bold text-primary shadow-sm" @onclick="AbrirModalNuevo">
                <i class="bi bi-plus-lg"></i> NUEVO CLIENTE
            </button>
        </div>

        @* Barra de Búsqueda (NUEVO) *@
        <div class="card-body bg-light border-bottom">
            <div class="row g-2">
                <div class="col-md-6 col-lg-4">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" class="form-control border-start-0"
                               placeholder="Buscar por RFC o Razón Social..."
                               @bind="filtros.BusquedaTexto"
                               @bind:event="oninput"
                               @onkeyup="@(e => { if (e.Key == "Enter") CargarClientes(1); })" />
                        <button class="btn btn-primary fw-bold" @onclick="() => CargarClientes(1)">BUSCAR</button>
                    </div>
                </div>
            </div>
        </div>

        @* === SECCIÓN 2: TABLA DE DATOS === *@
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0 small align-middle">
                    <thead class="table-light text-uppercase text-muted" style="font-size: 0.75rem;">
                        <tr>
                            <th class="ps-3 py-2">RFC</th>
                            <th class="py-2">Razón Social</th>
                            <th class="py-2">Contacto</th>
                            <th class="text-center py-2">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (respuesta == null)
                        {
                            <tr><td colspan="4" class="text-center py-4"><div class="spinner-border text-primary spinner-border-sm"></div> Cargando...</td></tr>
                        }
                        else if (respuesta.Elementos.Count == 0)
                        {
                            <tr><td colspan="4" class="text-center py-4 text-muted">No se encontraron clientes.</td></tr>
                        }
                        else
                        {
                            @foreach (var cliente in respuesta.Elementos)
                            {
                                <tr>
                                    <td class="ps-3 fw-bold text-primary">@cliente.RFC</td>
                                    <td>@cliente.RazonSocial</td>
                                    <td>@cliente.NombreContacto</td>
                                    <td class="text-center">
                                        <button class="btn btn-link btn-sm text-primary p-0 me-2" @onclick="() => Editar(cliente)">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                        <button class="btn btn-link btn-sm text-danger p-0" @onclick="() => Eliminar(cliente)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        @* === SECCIÓN 3: PAGINADOR (NUEVO) === *@
        @if (respuesta != null && respuesta.TotalPaginas >= 1)
        {
            <div class="card-footer bg-white py-2 d-flex justify-content-between align-items-center">
                <small class="text-muted">Total: <strong>@respuesta.TotalRegistros</strong> registros</small>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item @(filtros.Pagina == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => CargarClientes(filtros.Pagina - 1)">Anterior</button>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link bg-light text-dark border-0 mx-2">Pag. @filtros.Pagina de @respuesta.TotalPaginas</span>
                        </li>
                        <li class="page-item @(filtros.Pagina >= respuesta.TotalPaginas ? "disabled" : "")">
                            <button class="page-link" @onclick="() => CargarClientes(filtros.Pagina + 1)">Siguiente</button>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    </div>
</div>

@* === MODAL (TU CÓDIGO ORIGINAL INTACTO) === *@
@if (mostrarModal)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fs-6 text-uppercase fw-bold">
                        <i class="bi bi-person-vcard"></i> @(cliente.ClienteId > 0 ? "Editar Cliente" : "Nuevo Cliente")
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModal"></button>
                </div>

                <div class="modal-body bg-light">
                    @* 1. DATOS GENERALES *@
                    <div class="card border-0 shadow-sm p-3 mb-3">
                        <h6 class="text-primary fw-bold text-uppercase border-bottom pb-2 mb-3 small">Datos Generales</h6>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted">RFC *</label>
                                <input class="form-control form-control-sm text-uppercase fw-bold text-primary" @bind="cliente.RFC" placeholder="XAXX010101000" maxlength="13" />
                            </div>
                            <div class="col-md-5">
                                <label class="form-label small fw-bold text-muted">RAZÓN SOCIAL *</label>
                                <input class="form-control form-control-sm" @bind="cliente.RazonSocial" placeholder="Nombre de la empresa" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-muted">NOMBRE CONTACTO</label>
                                <input class="form-control form-control-sm" @bind="cliente.NombreContacto" />
                            </div>
                        </div>
                    </div>

                    @* 2. DETALLES (EMAILS Y TELÉFONOS) *@
                    <div class="row g-3">
                        @* COLUMNA IZQUIERDA: EMAILS *@
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-header bg-white py-2 border-bottom">
                                    <h6 class="mb-0 fw-bold text-secondary small text-uppercase"><i class="bi bi-envelope-at-fill"></i> Correos Electrónicos</h6>
                                </div>
                                <div class="card-body bg-white">
                                    <div class="input-group input-group-sm mb-3">
                                        <input type="text" class="form-control" placeholder="Etiqueta" @bind="tempEmail.Etiqueta" style="max-width: 30%;">
                                        <input type="text" class="form-control" placeholder="correo@ejemplo.com" @bind="tempEmail.Email">
                                        <button class="btn btn-success fw-bold" type="button" @onclick="AgregarEmail"><i class="bi bi-plus-lg"></i></button>
                                    </div>
                                    <div class="table-responsive border rounded">
                                        <table class="table table-sm table-striped mb-0 small align-middle">
                                            <thead class="table-light text-muted text-uppercase"><tr><th>Etiqueta</th><th>Email</th><th class="text-center" style="width:50px;">x</th></tr></thead>
                                            <tbody>
                                                @foreach (var item in cliente.Emails)
                                                {
                                                    <tr>
                                                        <td class="text-muted fst-italic">@item.Etiqueta</td>
                                                        <td class="fw-bold text-dark">@item.Email</td>
                                                        <td class="text-center"><button class="btn btn-link btn-sm text-danger p-0" @onclick="() => cliente.Emails.Remove(item)"><i class="bi bi-trash"></i></button></td>
                                                    </tr>
                                                }
                                                @if (!cliente.Emails.Any())
                                                {
                                                    <tr><td colspan="3" class="text-center text-muted py-2">Sin correos.</td></tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @* COLUMNA DERECHA: TELÉFONOS *@
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-header bg-white py-2 border-bottom">
                                    <h6 class="mb-0 fw-bold text-secondary small text-uppercase"><i class="bi bi-telephone-fill"></i> Teléfonos</h6>
                                </div>
                                <div class="card-body bg-white">
                                    <div class="input-group input-group-sm mb-3">
                                        <input type="text" class="form-control" placeholder="Etiqueta" @bind="tempTel.Etiqueta" style="max-width: 30%;">
                                        <input type="text" class="form-control" placeholder="55 1234 5678" @bind="tempTel.Numero">
                                        <button class="btn btn-success fw-bold" type="button" @onclick="AgregarTelefono"><i class="bi bi-plus-lg"></i></button>
                                    </div>
                                    <div class="table-responsive border rounded">
                                        <table class="table table-sm table-striped mb-0 small align-middle">
                                            <thead class="table-light text-muted text-uppercase"><tr><th>Etiqueta</th><th>Número</th><th class="text-center" style="width:50px;">x</th></tr></thead>
                                            <tbody>
                                                @foreach (var item in cliente.Telefonos)
                                                {
                                                    <tr>
                                                        <td class="text-muted fst-italic">@item.Etiqueta</td>
                                                        <td class="fw-bold text-dark">@item.Numero</td>
                                                        <td class="text-center"><button class="btn btn-link btn-sm text-danger p-0" @onclick="() => cliente.Telefonos.Remove(item)"><i class="bi bi-trash"></i></button></td>
                                                    </tr>
                                                }
                                                @if (!cliente.Telefonos.Any())
                                                {
                                                    <tr><td colspan="3" class="text-center text-muted py-2">Sin teléfonos.</td></tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer bg-light border-top-0">
                    <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="CerrarModal">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-sm fw-bold px-4" @onclick="Guardar"><i class="bi bi-save"></i> GUARDAR CLIENTE</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // 1. CAMBIO PRINCIPAL: Usamos el DTO de Respuesta Paginada en vez de List<>
    private PaginacionResponseDto<ClienteDto>? respuesta;
    private PaginacionRequestDto filtros = new PaginacionRequestDto { RegistrosPorPagina = 10 };

    // Variables del Modal (Se mantienen igual)
    private ClienteDto cliente = new();
    private bool mostrarModal = false;
    private ClienteEmail tempEmail = new();
    private ClienteTelefono tempTel = new();

    protected override async Task OnInitializedAsync()
    {
        await CargarClientes(1);
    }

    // 2. ACTUALIZADO: Acepta número de página y usa los filtros
    private async Task CargarClientes(int pagina)
    {
        try
        {
            filtros.Pagina = pagina;

            // Construimos la URL con parámetros
            var url = $"api/clientes?Pagina={filtros.Pagina}&RegistrosPorPagina={filtros.RegistrosPorPagina}";
            if (!string.IsNullOrEmpty(filtros.BusquedaTexto)) url += $"&BusquedaTexto={filtros.BusquedaTexto}";

            // Llamada a la API paginada
            respuesta = await Http.GetFromJsonAsync<PaginacionResponseDto<ClienteDto>>(url);
        }
        catch (Exception ex)
        {
            await MostrarToast($"Error al cargar: {ex.Message}", SweetAlertIcon.Error);
        }
    }

    private void AbrirModalNuevo()
    {
        cliente = new() { Activo = true, Emails = new(), Telefonos = new() };
        ResetTemporales();
        mostrarModal = true;
    }

    private void AgregarEmail()
    {
        if (string.IsNullOrEmpty(tempEmail.Email)) { MostrarToast("Correo obligatorio", SweetAlertIcon.Warning); return; }
        cliente.Emails.Add(tempEmail);
        tempEmail = new();
    }

    private void AgregarTelefono()
    {
        if (string.IsNullOrEmpty(tempTel.Numero)) { MostrarToast("Teléfono obligatorio", SweetAlertIcon.Warning); return; }
        cliente.Telefonos.Add(tempTel);
        tempTel = new();
    }

    private void ResetTemporales() { tempEmail = new(); tempTel = new(); }

    private void Editar(ClienteDto item)
    {
        // Clonamos el objeto para edición
        cliente = new ClienteDto
        {
            ClienteId = item.ClienteId,
            RFC = item.RFC,
            RazonSocial = item.RazonSocial,
            NombreContacto = item.NombreContacto,
            FechaRegistro = item.FechaRegistro,
            Activo = item.Activo,
            Emails = item.Emails != null ? item.Emails.ToList() : new(),
            Telefonos = item.Telefonos != null ? item.Telefonos.ToList() : new()
        };
        mostrarModal = true;
    }

    private void CerrarModal() => mostrarModal = false;

    private async Task Guardar()
    {
        if (string.IsNullOrEmpty(cliente.RFC) || cliente.RFC.Length < 12) { await MostrarToast("RFC inválido", SweetAlertIcon.Warning); return; }
        if (string.IsNullOrEmpty(cliente.RazonSocial)) { await MostrarToast("Razón Social obligatoria", SweetAlertIcon.Warning); return; }

        try
        {
            HttpResponseMessage response;
            if (cliente.ClienteId > 0)
                response = await Http.PutAsJsonAsync($"api/clientes/{cliente.ClienteId}", cliente);
            else
                response = await Http.PostAsJsonAsync("api/clientes", cliente);

            if (response.IsSuccessStatusCode)
            {
                await MostrarToast("Guardado correctamente", SweetAlertIcon.Success);
                CerrarModal();

                await CargarClientes(filtros.Pagina);
            }
            else
            {
                await MostrarToast("Error al guardar", SweetAlertIcon.Error);
            }
        }
        catch (Exception ex) { await MostrarToast($"Error: {ex.Message}", SweetAlertIcon.Error); }
    }

    private async Task Eliminar(ClienteDto item)
    {
        var result = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "¿Eliminar?",
            Text = $"Se dará de baja a: {item.RazonSocial}",
            Icon = SweetAlertIcon.Warning,
            ShowCancelButton = true,
            ConfirmButtonText = "Sí, eliminar",
            CancelButtonText = "Cancelar"
        });

        if (result.IsConfirmed)
        {
            var response = await Http.DeleteAsync($"api/clientes/{item.ClienteId}");
            if (response.IsSuccessStatusCode)
            {
                await MostrarToast("Eliminado correctamente", SweetAlertIcon.Success);
                // Recargamos la tabla
                await CargarClientes(filtros.Pagina);
            }
            else
            {
                await MostrarToast("No se pudo eliminar", SweetAlertIcon.Error);
            }
        }
    }

    private async Task MostrarToast(string mensaje, SweetAlertIcon icono)
    {
        await Swal.FireAsync(new SweetAlertOptions
        {
            Toast = true,
            Position = SweetAlertPosition.TopEnd,
            ShowConfirmButton = false,
            Timer = 2000,
            Icon = icono,
            Title = mensaje
        });
    }
}