@page "/usuarios"
@inject HttpClient Http
@inject SweetAlertService Swal
@using SistemaAduanero.Shared.DTOs

<div class="container-fluid mt-4">
    <div class="card shadow-sm border-0">
        @* HEADER AZUL ESTANDAR *@
        <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-person-gear"></i>
                <h6 class="mb-0 fw-bold text-uppercase">Gestión de Usuarios</h6>
            </div>
            <button class="btn btn-light btn-sm fw-bold text-primary shadow-sm" @onclick="AbrirModalNuevo">
                <i class="bi bi-plus-lg"></i> NUEVO USUARIO
            </button>
        </div>

        @* === BARRA DE BÚSQUEDA (NUEVO) === *@
        <div class="card-body bg-light border-bottom">
            <div class="row g-2">
                <div class="col-md-6 col-lg-4">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" class="form-control border-start-0"
                               placeholder="Buscar por Nombre o Usuario..."
                               @bind="filtros.BusquedaTexto"
                               @bind:event="oninput"
                               @onkeyup="@(e => { if (e.Key == "Enter") CargarUsuarios(1); })" />
                        <button class="btn btn-primary fw-bold" @onclick="() => CargarUsuarios(1)">BUSCAR</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0 small align-middle">
                    <thead class="table-light text-uppercase text-muted" style="font-size: 0.75rem;">
                        <tr>
                            <th class="ps-3 py-2">Usuario</th>
                            <th>Nombre Completo</th>
                            <th>Rol</th>
                            
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (respuesta == null)
                        {
                            <tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary spinner-border-sm"></div> Cargando...</td></tr>
                        }
                        else if (respuesta.Elementos.Count == 0)
                        {
                            <tr><td colspan="5" class="text-center py-4 text-muted">No se encontraron usuarios.</td></tr>
                        }
                        else
                        {
                            @foreach (var item in respuesta.Elementos)
                            {
                                <tr>
                                    <td class="ps-3 fw-bold text-primary">@item.Username</td>
                                    <td>@item.NombreCompleto</td>
                                    <td>
                                        <span class="badge bg-light text-dark border">
                                            @(item.Rol != null ? item.Rol.NombreRol : "Sin Rol")
                                        </span>
                                    </td>
                                    
                                    <td class="text-center">
                                        <button class="btn btn-link btn-sm text-primary p-0 me-2" @onclick="() => Editar(item)">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                        <button class="btn btn-link btn-sm text-danger p-0" @onclick="() => Eliminar(item)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        @* === PAGINADOR (NUEVO) === *@
        @if (respuesta != null && respuesta.TotalPaginas >= 1)
        {
            <div class="card-footer bg-white py-2 d-flex justify-content-between align-items-center">
                <small class="text-muted">Total: <strong>@respuesta.TotalRegistros</strong> usuarios</small>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item @(filtros.Pagina == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => CargarUsuarios(filtros.Pagina - 1)">Anterior</button>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link bg-light text-dark border-0 mx-2">Pag. @filtros.Pagina de @respuesta.TotalPaginas</span>
                        </li>
                        <li class="page-item @(filtros.Pagina >= respuesta.TotalPaginas ? "disabled" : "")">
                            <button class="page-link" @onclick="() => CargarUsuarios(filtros.Pagina + 1)">Siguiente</button>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    </div>
</div>

@* === MODAL === *@
@if (mostrarModal)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fs-6 text-uppercase fw-bold">
                        <i class="bi bi-person-fill"></i> @(usuario.UsuarioId > 0 ? "Editar Usuario" : "Nuevo Usuario")
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body bg-light">

                    @* SECCIÓN 1: DATOS DE ACCESO *@
                    <div class="card border-0 shadow-sm p-3 mb-3">
                        <h6 class="text-primary fw-bold text-uppercase border-bottom pb-2 mb-3 small">Credenciales</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">NOMBRE COMPLETO *</label>
                                <input class="form-control form-control-sm" @bind="usuario.NombreCompleto" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">ROL *</label>
                                <InputSelect class="form-select form-select-sm" @bind-Value="usuario.RolId">
                                    <option value="0">-- Seleccione --</option>
                                    @foreach (var r in ListaRoles)
                                    {
                                        <option value="@r.RolId">@r.NombreRol</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">USUARIO (LOGIN) *</label>
                                <input class="form-control form-control-sm" @bind="usuario.Username" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">CONTRASEÑA</label>
                                <input type="password" class="form-control form-control-sm" @bind="usuario.PasswordSinEncriptar"
                                       placeholder="@(usuario.UsuarioId > 0 ? "Dejar vacío para mantener actual" : "Requerida")" />
                            </div>
                        </div>
                    </div>

                    @* SECCIÓN 2: ASIGNACIÓN DE CLIENTES (CHECKLIST) *@
                    <div class="card border-0 shadow-sm p-3">
                        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                            <h6 class="text-primary fw-bold text-uppercase small mb-0">Asignar Clientes Permitidos</h6>
                            <button class="btn btn-outline-secondary btn-sm py-0" style="font-size: 0.7rem;" @onclick="SeleccionarTodos">
                                <i class="bi bi-check-all"></i> Todos/Ninguno
                            </button>
                        </div>

                        @* Contenedor con Scroll para muchos clientes *@
                        <div class="d-flex flex-wrap gap-2 bg-white border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            @if (ListaTodosClientes != null)
                            {
                                @foreach (var cte in ListaTodosClientes)
                                {
                                    bool isChecked = ClientesSeleccionadosIds.Contains(cte.ClienteId);

                                    <div class="form-check form-check-inline px-3 py-1 m-1 border rounded @(isChecked ? "border-primary bg-primary bg-opacity-10" : "bg-light")" style="cursor: pointer;">
                                        <input class="form-check-input" type="checkbox"
                                               checked="@isChecked"
                                               @onchange="@(e => ToggleCliente(cte.ClienteId, e.Value))"
                                               id="cte_@cte.ClienteId">
                                        <label class="form-check-label small user-select-none" for="cte_@cte.ClienteId" style="cursor: pointer;">
                                            @cte.RazonSocial
                                        </label>
                                    </div>
                                }
                            }
                        </div>
                        <div class="form-text mt-1 text-end">
                            <small>Seleccionados: @ClientesSeleccionadosIds.Count</small>
                        </div>
                    </div>

                </div>
                <div class="modal-footer bg-light border-top-0">
                    <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="CerrarModal">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-sm fw-bold px-4" @onclick="Guardar">
                        <i class="bi bi-save"></i> GUARDAR USUARIO
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // 1. Listas Maestras
    private PaginacionResponseDto<Usuario>? respuesta; 
    private PaginacionRequestDto filtros = new PaginacionRequestDto { RegistrosPorPagina = 10 };
    private List<Usuario>? ListaUsuarios;
    private List<Role> ListaRoles = new();
    private List<ClienteDto> ListaTodosClientes = new();

    // 2. Variables de Edición
    private Usuario usuario = new();
    private HashSet<int> ClientesSeleccionadosIds = new(); // Usamos HashSet para búsquedas rápidas
    private bool mostrarModal = false;

    // 3. Carga Inicial
    protected override async Task OnInitializedAsync()
    {
        //await CargarDatosCompletos();
        await CargarCatalogosIniciales();
        await CargarUsuarios(1);
    }

    // private async Task CargarDatosCompletos()
    // {
    //     try
    //     {
    //         // Ejecutamos las 3 llamadas en paralelo para ser más rápidos
    //         var t1 = Http.GetFromJsonAsync<List<Usuario>>("api/usuarios");
    //         var t2 = Http.GetFromJsonAsync<List<Role>>("api/roles"); // Verifica que tengas este controller
    //         var t3 = Http.GetFromJsonAsync<List<ClienteDto>>("api/clientes/lista-simple");

    //         await Task.WhenAll(t1, t2, t3);

    //         ListaUsuarios = t1.Result ?? new();
    //         ListaRoles = t2.Result ?? new();
    //         ListaTodosClientes = t3.Result ?? new();
    //     }
    //     catch (Exception ex)
    //     {
    //         Console.WriteLine(ex.Message);
    //         await MostrarToast("No se pudieron cargar los catálogos.", SweetAlertIcon.Error);
    //     }
    // }

    // 4. Modal y Edición
    private void AbrirModalNuevo()
    {
        usuario = new() { Activo = true, RolId = 0, UsuarioClientes = new List<UsuarioCliente>() };
        ClientesSeleccionadosIds.Clear();
        mostrarModal = true;
    }

    private async Task CargarCatalogosIniciales()
    {
        try
        {
            // Aquí SÍ usamos tu lógica paralela con Task.WhenAll ¡Es excelente aquí!
            var tRoles = Http.GetFromJsonAsync<List<Role>>("api/roles");
            var tClientes = Http.GetFromJsonAsync<List<ClienteDto>>("api/clientes/lista-simple");

            await Task.WhenAll(tRoles, tClientes);

            ListaRoles = tRoles.Result ?? new();
            ListaTodosClientes = tClientes.Result ?? new();
        }
        catch (Exception ex)
        {
            await MostrarToast("Error cargando catálogos: "+ex.Message ,SweetAlertIcon.Error);
        }
    }

    private async Task CargarUsuarios(int pagina)
    {
        try
        {
            filtros.Pagina = pagina;

            // Construimos URL con Query Strings
           
            var url = $"api/usuarios?Pagina={filtros.Pagina}&RegistrosPorPagina={filtros.RegistrosPorPagina}";
            if (!string.IsNullOrEmpty(filtros.BusquedaTexto)) url += $"&BusquedaTexto={filtros.BusquedaTexto}";
            

            // Petición Paginada
            respuesta = await Http.GetFromJsonAsync<PaginacionResponseDto<Usuario>>(url);
        }
        catch (Exception ex)
        {
            await MostrarToast("No se pudieron cargar los usuarios: "+ex.Message, SweetAlertIcon.Error);
        }
    }

    private void Editar(Usuario item)
    {
        // Clonamos el objeto para edición segura
        usuario = new Usuario
        {
            UsuarioId = item.UsuarioId,
            NombreCompleto = item.NombreCompleto,
            Username = item.Username,
            RolId = item.RolId,
            Activo = item.Activo,
            PasswordHash = item.PasswordHash, // Conservamos el hash viejo
            UsuarioClientes = new List<UsuarioCliente>() // Reiniciamos la lista local
        };

        // Llenamos el HashSet visual con los IDs que el usuario YA tiene
        ClientesSeleccionadosIds = item.UsuarioClientes.Select(uc => uc.ClienteId).ToHashSet();

        mostrarModal = true;
    }

    // 5. Lógica del Checklist
    private void ToggleCliente(int clienteId, object? checkedValue)
    {
        bool isChecked = (bool)(checkedValue ?? false);
        if (isChecked) ClientesSeleccionadosIds.Add(clienteId);
        else ClientesSeleccionadosIds.Remove(clienteId);
    }

    private void SeleccionarTodos()
    {
        if (ClientesSeleccionadosIds.Count == ListaTodosClientes.Count)
            ClientesSeleccionadosIds.Clear(); // Si ya están todos, limpiar
        else
            ClientesSeleccionadosIds = ListaTodosClientes.Select(c => c.ClienteId).ToHashSet(); // Sino, seleccionar todos
    }

    // 6. Guardar
    private async Task Guardar()
    {
        // Validaciones básicas
        if (string.IsNullOrEmpty(usuario.NombreCompleto) || string.IsNullOrEmpty(usuario.Username) || usuario.RolId == 0)
        {
            await MostrarToast("Faltan datos: Verifica nombre, usuario y rol.", SweetAlertIcon.Warning);

            return;
        }
        if (usuario.UsuarioId == 0 && string.IsNullOrEmpty(usuario.PasswordSinEncriptar))
        {
            await MostrarToast("Contraseña Requerida: Para usuarios nuevos debes asignar una contraseña.", SweetAlertIcon.Warning);
            return;
        }
        if (ClientesSeleccionadosIds.Count == 0)
        {
            // Opcional: Advertencia si no asignó ningún cliente
            await MostrarToast("Ojo: No asignaste ningún cliente.", SweetAlertIcon.Info);
        }

        // PREPARAR EL OBJETO PARA ENVIAR AL BACKEND
        // Convertimos los IDs seleccionados (HashSet) en la lista de objetos que espera la API
        usuario.UsuarioClientes = ClientesSeleccionadosIds.Select(id => new UsuarioCliente
        {
            ClienteId = id
            // El UsuarioId lo asigna el backend
        }).ToList();

        try
        {
            HttpResponseMessage resp;
            if (usuario.UsuarioId > 0)
                resp = await Http.PutAsJsonAsync($"api/usuarios/{usuario.UsuarioId}", usuario);
            else
                resp = await Http.PostAsJsonAsync("api/usuarios", usuario);

            if (resp.IsSuccessStatusCode)
            {
                await MostrarToast("Cambios aplicados correctamente.", SweetAlertIcon.Success);
                //await CargarDatosCompletos(); // Recargar tabla
                await CargarUsuarios(filtros.Pagina);
                CerrarModal();
            }
            else
            {
                var msg = await resp.Content.ReadAsStringAsync(); //TODO: implementar un log para guardar todos los errores. 
                await MostrarToast("El usuario ya existe (o está desactivado). Intenta con otro nombre.", SweetAlertIcon.Error);
            }
        }
        catch (Exception ex)
        {
            await MostrarToast("Error Crítico: "+ex.Message, SweetAlertIcon.Error);
        }
    }

    private void CerrarModal() => mostrarModal = false;

    private async Task Eliminar(Usuario u)
    {


        var conf = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "¿Desactivar Usuario?",
            Text = $"Se quitará el acceso a: {u.Username}",
            Icon = SweetAlertIcon.Warning,
            ShowCancelButton = true,
            ConfirmButtonText = "Sí, desactivar"
        });

        if (conf.IsConfirmed)
        {
            var resp = await Http.DeleteAsync($"api/usuarios/{u.UsuarioId}");
            if (resp.IsSuccessStatusCode)
            {
                //await CargarDatosCompletos();
                await CargarUsuarios(filtros.Pagina);

                await MostrarToast("El usuario a sido desactivado", SweetAlertIcon.Success);

            }
            else
            {
                // Leer el error del backend (por ejemplo, si intentó borrarse a sí mismo)
                var errorMsg = await resp.Content.ReadAsStringAsync();
                await MostrarToast("Error"+  errorMsg, SweetAlertIcon.Error);
            }

        }
    }

    private async Task MostrarToast(string mensaje, SweetAlertIcon icono)
    {
        await Swal.FireAsync(new SweetAlertOptions
        {
            Toast = true,
            Position = SweetAlertPosition.TopEnd, // Arriba a la derecha
            ShowConfirmButton = false,
            Timer = 3000,
            Icon = icono,
            Title = mensaje
        });
    }

    private async Task<bool> Confirmar(string titulo, string mensaje, string textoBoton)
    {
        var resultado = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = titulo,
            Text = mensaje,
            Icon = SweetAlertIcon.Warning,
            ShowCancelButton = true,
            ConfirmButtonText = textoBoton,
            CancelButtonText = "Cancelar",
            ConfirmButtonColor = "#d33", // Color rojo estándar para acciones destructivas
            CancelButtonColor = "#3085d6"
        });

        return resultado.IsConfirmed;
    }
}