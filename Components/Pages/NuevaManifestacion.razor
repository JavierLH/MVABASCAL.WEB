@page "/manifestaciones/nueva"
@page "/manifestaciones/editar/{Id:int}"
@using SistemaAduanero.Shared.DTOs
@using SistemaAduanero.Shared.DTOs.SistemaAduanero.Shared.DTOs
@inject SweetAlertService Swal
@inject HttpClient Http
@inject NavigationManager NavManager
@rendermode InteractiveServer
@using System.Text.Json
@attribute [Authorize]

<div class="container-fluid mt-4">

    @* === CABECERA PRINCIPAL Y DATOS GENERALES === *@
    <div class="card shadow-sm border-0 mb-4">
        @* Header Estandarizado *@
        <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-folder-fill"></i>
                <h6 class="mb-0 fw-bold text-uppercase">Expediente de Valor</h6>
               
            </div>
            <button class="btn btn-light btn-sm fw-bold text-primary shadow-sm" @onclick="GuardarTodo">
                <i class="bi bi-floppy-fill"></i> GUARDAR
            </button>
        </div>

        <div class="card-body bg-white">
            @* FILA 1: DATOS DE IDENTIFICACIÓN *@
            <div class="row g-3 mb-4">

                @* COLUMNA 1: PEDIMENTO (3 espacios) *@
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">NÚMERO PEDIMENTO</label>
                    <InputText class="form-control form-control-sm fw-bold text-primary"
                               @bind-Value="manifestacion.ReferenciaAdmin"
                               placeholder="Ej: 5000001"
                               disabled="@bloquearCamposAA" />
                </div>

                @* COLUMNA 2: REFERENCIA (3 espacios) - NUEVO CAMPO *@
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">REFERENCIA</label>
                    <InputText class="form-control form-control-sm fw-bold text-dark"
                               @bind-Value="manifestacion.Referencia"
                               placeholder="Ej: INT-2024-001"
                               disabled="@bloquearCamposAA" />
                </div>

                @* COLUMNA 3: CLIENTE (3 espacios) *@
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">CLIENTE / IMPORTADOR *</label>
                    <InputSelect class="form-select form-select-sm"
                                 Value="clienteSeleccionadoId"
                                 ValueChanged="@((int id) => OnClienteSeleccionado(id))"
                                 ValueExpression="@(() => clienteSeleccionadoId)"
                                 disabled="@bloquearCamposAA">
                        <option value="0">-- Seleccione --</option>
                        @if (ListaMisClientes != null)
                        {
                            @foreach (var cte in ListaMisClientes)
                            {
                                <option value="@cte.ClienteId">@cte.RazonSocial</option>
                            }
                        }
                    </InputSelect>
                </div>

                @* COLUMNA 4: RFC (3 espacios) *@
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">RFC SELECCIONADO</label>
                    <input class="form-control form-control-sm bg-light"
                           value="@manifestacion.Cliente?.RFC" readonly />
                </div>

                @* NOTA (Nueva fila o debajo) *@
                <div class="col-md-12 mt-2">
                    <div class="alert alert-light border d-flex align-items-center p-2 mb-0 small text-muted">
                        <i class="bi bi-info-circle-fill text-info me-2 fs-5"></i>
                        <div>
                            <strong>Nota:</strong> Ingrese los totales globales tal como aparecen en el pedimento.
                        </div>
                    </div>
                </div>
            </div>

            @* SECCIÓN DE TOTALES (Diseño "Caja Gris" limpia) *@
            <div class="p-3 bg-light rounded border">
                <h6 class="text-primary fw-bold text-uppercase mb-3" style="font-size: 0.8rem;">
                    <i class="bi bi-calculator"></i> Totales (Valor en Aduana)
                </h6>
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted">PRECIO PAGADO</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-white text-muted">$</span>
                            <InputNumber class="form-control text-end" @bind-Value="manifestacion.TotalPrecioPagado" />
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted">PRECIO POR PAGAR</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-white text-muted">$</span>
                            <InputNumber class="form-control text-end" @bind-Value="manifestacion.TotalPrecioPorPagar" />
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted">INCREMENTABLES</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-white text-muted">$</span>
                            <InputNumber class="form-control text-end" @bind-Value="manifestacion.TotalIncrementables" />
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted">DECREMENTABLES</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-white text-muted">$</span>
                            <InputNumber class="form-control text-end" @bind-Value="manifestacion.TotalDecrementables" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold text-success">TOTAL VALOR ADUANA</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-success text-white border-success">$</span>
                            <InputNumber class="form-control fw-bold text-end border-success text-success" @bind-Value="manifestacion.TotalValorAduana" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        @* === SECCIÓN IZQUIERDA: RFCs CONSULTA === *@
        <div class="col-md-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-2 border-bottom">
                    <h6 class="mb-0 fw-bold text-secondary text-uppercase"><i class="bi bi-people-fill"></i> Personas Consulta</h6>
                </div>
                <div class="card-body bg-light">
                    @* Formulario Agregar RFC *@
                    @if(!bloquearCamposAA)
                    {
                        @if ( manifestacion.Consultas.Count<1) 
                        {
                            <div class="card p-3 mb-3 border-0 shadow-sm">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <label class="form-label small fw-bold text-muted">RFC CONSULTA</label>
                                        <InputText class="form-control form-control-sm" @bind-Value="tempRfc.RfcConsulta" placeholder="Capturar RFC..." disabled="@bloquearCamposAA" />
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label small fw-bold text-muted">TIPO FIGURA</label>
                                        <InputSelect class="form-select form-select-sm" @bind-Value="tempRfc.TipoFigura" disabled="@bloquearCamposAA">
                                            <option value="">-- Seleccione --</option>
                                            @foreach (var tf in ListaTiposFigura)
                                            {
                                                <option value="@tf.Clave">@tf.Clave - @tf.Descripcion</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div class="col-12 mt-3">
                                        <button class="btn btn-primary btn-sm w-100 fw-bold" @onclick="AgregarRfcConsulta">
                                            <i class="bi bi-plus-lg"></i> AGREGAR
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    }

                    @* Lista Standard *@
                    <ul class="list-group list-group-flush border rounded bg-white">
                        @foreach (var item in manifestacion.Consultas)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                                <div>
                                    <span class="fw-bold d-block small text-dark">@item.RfcConsulta</span>
                                    <span class="badge bg-light text-secondary border">@item.TipoFigura</span>
                                </div>
                               @if(!bloquearCamposAA)
                               {
                                    <button class="btn btn-link btn-sm text-danger p-0" @onclick="() => manifestacion.Consultas.Remove(item)" >
                                        <i class="bi bi-trash"></i>
                                    </button>
                                }
                            </li>
                        }
                        @if (manifestacion.Consultas.Count == 0)
                        {
                            <li class="list-group-item text-center text-muted small py-3 bg-light">
                                Sin personas asociadas.
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>

        @* === SECCIÓN DERECHA: LISTADO DE COVES === *@
        <div class="col-md-8">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-2 border-bottom d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-secondary text-uppercase"><i class="bi bi-file-earmark-text-fill"></i> Documentos COVE</h6>
                    <button class="btn btn-primary btn-sm fw-bold" @onclick="AbrirModalNuevo">
                        <i class="bi bi-plus-lg"></i> NUEVO COVE
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0 small align-middle">
                            <thead class="table-light text-uppercase text-muted" style="font-size: 0.75rem;">
                                <tr>
                                    <th class="ps-3 py-2">COVE</th>
                                    <th class="py-2">Incoterm</th>
                                    <th class="py-2">Aduana</th>
                                    <th class="text-center py-2">Pagos</th>
                                    <th class="text-center py-2">Conceptos</th>
                                    <th class="text-end pe-3 py-2">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in manifestacion.Coves)
                                {
                                    <tr>
                                        <td class="ps-3 fw-bold text-primary">@item.NumeroCove</td>
                                        <td>@item.Incoterm</td>
                                        <td>@item.Aduana</td>
                                        <td class="text-center">
                                            @if (item.PreciosPagados.Any())
                                            {
                                                <span class="badge bg-success me-1" title="Pagados">@item.PreciosPagados.Count</span>
                                            }
                                            @if (item.PreciosPorPagar.Any())
                                            {
                                                <span class="badge bg-warning text-dark me-1" title="Por Pagar">@item.PreciosPorPagar.Count</span>
                                            }
                                            @if (item.Compensaciones.Any())
                                            {
                                                <span class="badge bg-info text-dark" title="Compensaciones">@item.Compensaciones.Count</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            @if (item.Incrementables.Any())
                                            {
                                                <span class="badge bg-primary bg-opacity-75 me-1" title="Incrementables">+ @item.Incrementables.Count</span>
                                            }
                                            @if (item.Decrementables.Any())
                                            {
                                                <span class="badge bg-danger bg-opacity-75" title="Decrementables">- @item.Decrementables.Count</span>
                                            }
                                        </td>
                                        <td class="text-end pe-3">
                                            <button class="btn btn-link btn-sm text-primary p-0 me-2" @onclick="() => CargarDatosParaEditar(item)"><i class="bi bi-pencil-square"></i></button>
                                            <button class="btn btn-link btn-sm text-danger p-0"
                                                    @onclick="() => ConfirmarEliminarCove(item)" title="Eliminar COVE">
                                                <i class="bi bi-trash"></i>
                                        </button>
                                        </td>
                                    </tr>
                                }
                                @if (manifestacion.Coves.Count == 0)
                                {
                                    <tr><td colspan="6" class="text-center py-4 text-muted small">No hay documentos registrados. Pulse "Nuevo COVE" para comenzar.</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* === MODAL DE CAPTURA DE COVE === *@
@if (mostrarModal)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fs-6 text-uppercase fw-bold">
                        <i class="bi bi-pencil-square"></i> @(coveEnEdicion != null ? "Editar COVE" : "Nuevo COVE")
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModal"></button>
                </div>

                <div class="modal-body bg-light">
                    <EditForm Model="@coveTemporal" OnValidSubmit="GuardarCoveEnLista">
                        <DataAnnotationsValidator />

                        @* TABS ESTANDARIZADAS (Iconos Bootstrap) *@
                        <ul class="nav nav-pills mb-3 bg-white p-2 rounded border shadow-sm" style="font-size: 0.9rem;">
                            <li class="nav-item">
                                <button class="nav-link @(tabActiva == 1 ? "active fw-bold" : "text-muted")" type="button" @onclick="() => tabActiva = 1">
                                    <i class="bi bi-file-earmark-text"></i> Generales
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link @(tabActiva == 2 ? "active fw-bold" : "text-muted")" type="button" @onclick="() => tabActiva = 2">
                                    <i class="bi bi-cash-stack"></i> Pagados <span class="badge bg-light text-dark ms-1">@coveTemporal.PreciosPagados.Count</span>
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link @(tabActiva == 3 ? "active fw-bold" : "text-muted")" type="button" @onclick="() => tabActiva = 3">
                                    <i class="bi bi-clock-history"></i> Por Pagar <span class="badge bg-light text-dark ms-1">@coveTemporal.PreciosPorPagar.Count</span>
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link @(tabActiva == 4 ? "active fw-bold" : "text-muted")" type="button" @onclick="() => tabActiva = 4">
                                    <i class="bi bi-arrow-left-right"></i> Compensaciones <span class="badge bg-light text-dark ms-1">@coveTemporal.Compensaciones.Count</span>
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link @(tabActiva == 5 ? "active fw-bold" : "text-muted")" type="button" @onclick="() => tabActiva = 5">
                                    <i class="bi bi-calculator"></i> Conceptos +/-
                                </button>
                            </li>
                        </ul>

                        @* TAB 1: GENERALES *@
                        <div class="@(tabActiva == 1 ? "d-block" : "d-none")">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold text-muted">NÚMERO COVE *</label>
                                            <InputText class="form-control form-control-sm" @bind-Value="coveTemporal.NumeroCove" disabled="@bloquearCamposAA" />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold text-muted">INCOTERM</label>
                                            <InputSelect class="form-select form-select-sm" @bind-Value="coveTemporal.Incoterm" disabled="@bloquearCamposAA">
                                                <option value="">-- Seleccione --</option>
                                                @foreach (var item in ListaIncoterms)
                                                {
                                                    <option value="@item.Clave">@item.Clave - @item.Descripcion</option>
                                                }
                                            </InputSelect>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold text-muted">VINCULACIÓN</label>
                                            <InputSelect class="form-select form-select-sm" @bind-Value="coveTemporal.ExisteVinculacion" disabled="@bloquearCamposAA">
                                                <option value="false">NO</option>
                                                <option value="true">SÍ</option>
                                            </InputSelect>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold text-muted">MÉTODO VALORACIÓN</label>
                                            <InputSelect class="form-select form-select-sm" @bind-Value="coveTemporal.MetodoValoracion" disabled="@bloquearCamposAA">
                                                <option value="">-- Seleccione --</option>
                                                @foreach (var item in ListaMetodosValoracion)
                                                {
                                                    <option value="@item.Clave">@item.Clave - @item.Descripcion</option>
                                                }
                                            </InputSelect>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold text-muted">ADUANA</label>
                                            <InputText class="form-control form-control-sm" @bind-Value="coveTemporal.Aduana"
                                                       placeholder="Ej: VERACRUZ" />
                                            <ValidationMessage For="@(() => coveTemporal.Aduana)" />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold text-muted">PATENTE</label>
                                            <InputText class="form-control form-control-sm" @bind-Value="coveTemporal.Patente"/>
                                            <ValidationMessage For="@(() => coveTemporal.Patente)" />
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold text-muted">FACTURA</label>
                                            <InputText class="form-control form-control-sm" @bind-Value="coveTemporal.NumeroPedimento" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @* TAB 2: PAGADOS *@
                        <div class="@(tabActiva == 2 ? "d-block" : "d-none")">
                            <div class="p-3 bg-white rounded border mb-3 shadow-sm">
                                <div class="row g-2 align-items-end">

                                    <div class="col-md-3"><label class="form-label small fw-bold text-muted">FECHA</label><InputDate class="form-control form-control-sm" @bind-Value="tempPagado.FechaPago" /></div>
                                    <div class="col-md-3"><label class="form-label small fw-bold text-muted">TOTAL</label><InputNumber class="form-control form-control-sm" @bind-Value="tempPagado.Total" /></div>
                                    <div class="col-md-2">
                                        <label class="form-label small fw-bold text-muted">MONEDA</label>
                                        <InputSelect class="form-select form-select-sm" @bind-Value="tempPagado.TipoMoneda">
                                            <option value="">-- Selecione --</option>
                                            @foreach (var m in ListaMonedas)
                                            {
                                                <option value="@m.Clave">@m.Clave - @m.Descripcion</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div class="col-md-2"><label class="form-label small fw-bold text-muted">T.C.</label><InputNumber class="form-control form-control-sm" @bind-Value="tempPagado.TipoCambio" /></div>
                                    <div class="col-md-2">
                                        <button type="button"
                                                class="btn btn-sm w-100 fw-bold @(pagadoEnEdicion != null ? "btn-warning text-dark" : "btn-primary")"
                                                @onclick="AgregarPagado">
                                            <i class="bi @(pagadoEnEdicion != null ? "bi-pencil-square" : "bi-plus-lg")"></i>
                                            @(pagadoEnEdicion != null ? "ACTUALIZAR" : "AGREGAR")
                                        </button>
                                    </div>

                                   
                                    @if (pagadoEnEdicion != null)
                                    {
                                        <div class="col-md-12 text-end mt-1 fade-in">
                                            <button type="button" class="btn btn-link btn-sm text-muted fst-italic py-0"
                                                @onclick="() => { pagadoEnEdicion = null; tempPagado = new(); }">Cancelar Edición
                                            </button>
                                        </div>
                                    }
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-12">
                                        <label class="form-label small fw-bold text-muted">FORMA PAGO *</label>
                                        <InputSelect class="form-select form-select-sm" @bind-Value="tempPagado.TipoPago">
                                            <option value="">-- Seleccione --</option>
                                            @foreach (var fp in ListaFormasPago)
                                            {
                                                <option value="@fp.Clave">@fp.Clave - @fp.Descripcion</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    @if (tempPagado.TipoPago == "FORPAG.OT")
                                    {
                                        <div class="col-md-12 mt-2 fade-in">
                                            <label class="form-label small fw-bold text-muted">ESPECIFIQUE *</label>
                                            <InputText class="form-control form-control-sm"
                                                       @bind-Value="tempPagado.DescripcionOtroPago"
                                                       placeholder="Escriba el detalle del pago..." />
                                        </div>
                                    }
                                </div>
                            </div>

                            @* Tabla Estandarizada *@
                            <div class="table-responsive border rounded bg-white">
                                <table class="table table-sm table-striped table-hover mb-0 small">
                                    <thead class="table-light text-uppercase text-muted" style="font-size:0.75rem;"><tr><th class="py-2">Fecha</th><th class="py-2">Forma Pago</th><th class="text-center py-2">Moneda</th><th class="text-end py-2">TC</th><th class="text-end py-2">Total</th><th class="text-center py-2">Acción</th></tr></thead>
                                    <tbody>
                                        @foreach (var item in coveTemporal.PreciosPagados)
                                        {
                                            <tr>
                                                <td>@item.FechaPago?.ToShortDateString()</td>
                                                <td>
                                                    @item.TipoPago
                                                    @if (!string.IsNullOrEmpty(item.DescripcionOtroPago))
                                                    {
                                                        <span class="text-muted fst-italic ms-1">(@item.DescripcionOtroPago)</span>
                                                    }
                                                </td>
                                                <td class="text-center">@item.TipoMoneda</td>
                                                <td class="text-end">@item.TipoCambio</td>
                                                <td class="text-end">@item.Total</td>

                                                <td class="text-center">
                                                    @* Botón Editar *@
                                                    <button type="button" class="btn btn-link text-primary p-0 me-2"
                                                            @onclick="() => EditarPagado(item)">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>

                                                    @* Botón Eliminar *@
                                                    <button type="button" class="btn btn-link text-danger p-0"
                                                            @onclick='() => ConfirmarEliminarSubItem("Se eliminará este pago.", () => coveTemporal.PreciosPagados.Remove(item))'>
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        @* TAB 3: POR PAGAR *@
                        <div class="@(tabActiva == 3 ? "d-block" : "d-none")">
                            <div class="p-3 bg-white rounded border mb-3 shadow-sm">
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-3"><label class="form-label small fw-bold text-muted">FECHA</label><InputDate class="form-control form-control-sm" @bind-Value="tempPorPagar.FechaPago" /></div>
                                    <div class="col-md-3"><label class="form-label small fw-bold text-muted">TOTAL</label><InputNumber class="form-control form-control-sm" @bind-Value="tempPorPagar.Total" /></div>
                                    <div class="col-md-2">
                                        <label class="form-label small fw-bold text-muted">MONEDA</label>
                                        <InputSelect class="form-select form-select-sm" @bind-Value="tempPorPagar.TipoMoneda">
                                            <option value="">-- Seleccione --</option>
                                            @foreach (var m in ListaMonedas)
                                            {
                                                <option value="@m.Clave">@m.Clave - @m.Descripcion</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div class="col-md-2"><label class="form-label small fw-bold text-muted">T.C.</label><InputNumber class="form-control form-control-sm" @bind-Value="tempPorPagar.TipoCambio" /></div>
                                    <div class="col-md-2">
                                        <button type="button"
                                                class="btn btn-sm w-100 fw-bold @(porPagarEnEdicion != null ? "btn-warning text-dark" : "btn-primary")"
                                                @onclick="AgregarPorPagar">
                                            <i class="bi @(porPagarEnEdicion != null ? "bi-pencil-square" : "bi-plus-lg")"></i>
                                            @(porPagarEnEdicion != null ? "ACTUALIZAR" : "AGREGAR")
                                        </button>
                                    </div>

                                    @if (porPagarEnEdicion != null)
                                    {
                                        <div class="col-md-12 text-end mt-1 fade-in">
                                            <button type="button" class="btn btn-link btn-sm text-muted fst-italic py-0"
                                                    @onclick="() => { porPagarEnEdicion = null; tempPorPagar = new(); }">
                                                <i class="bi bi-x-circle"></i> Cancelar Edición
                                            </button>
                                        </div>
                                    }
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">FORMA PAGO *</label>
                                        <InputSelect class="form-select form-select-sm" @bind-Value="tempPorPagar.TipoPago">
                                            <option value="">-- Seleccione --</option>
                                            @foreach (var fp in ListaFormasPago)
                                            {
                                                <option value="@fp.Clave">@fp.Clave - @fp.Descripcion</option>
                                            }
                                        </InputSelect>
                                        @if (tempPorPagar.TipoPago == "FORPAG.OT")
                                        {
                                            <div class="col-md-12 mt-2 fade-in">
                                                <label class="form-label small fw-bold text-muted">ESPECIFIQUE *</label>
                                                <InputText class="form-control form-control-sm"
                                                           @bind-Value="tempPorPagar.DescripcionOtroPago"
                                                           placeholder="Escriba el detalle del pago..." />
                                            </div>
                                        }
                                    </div>
                                    
                                    <div class="col-md-6"><label class="form-label small fw-bold text-muted">COMENTARIOS</label><InputText class="form-control form-control-sm" @bind-Value="tempPorPagar.SituacionNoFechaPago" /></div>
                                </div>
                            </div>

                            <div class="table-responsive border rounded bg-white">
                                <table class="table table-sm table-striped table-hover mb-0 small">
                                    <thead class="table-light text-uppercase text-muted" style="font-size:0.75rem;">
                                        <tr>
                                            <th class="py-2">Fecha</th>
                                            <th class="py-2">Forma Pago</th>

                                            <th class="py-2">t.c</th>
                                            <th class="text-center py-2">Moneda</th>
                                            <th class="py-2">Total</th>
                                            <th class="text-end py-2">comentarios</th>
                                            <th class="text-center py-2">Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in coveTemporal.PreciosPorPagar)
                                        {
                                            <tr>
                                                <td>@(item.FechaPago.Value.ToShortDateString())</td>
                                                <td>
                                                    @item.TipoPago
                                                    @if (!string.IsNullOrEmpty(item.DescripcionOtroPago))
                                                    {
                                                        <span class="text-muted fst-italic ms-1">(@item.DescripcionOtroPago)</span>
                                                    }
                                                </td>
                                                <td>@item.TipoCambio</td>
                                                <td class="text-center">@item.TipoMoneda</td>
                                                <td>@item.Total</td>
                                                <td class="text-end">@item.SituacionNoFechaPago</td>
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-link text-primary p-0 me-2"
                                                            @onclick="() => EditarPorPagar(item)" title="Editar">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>

                                                    <button type="button" class="btn btn-link text-danger p-0"
                                                            @onclick='() => ConfirmarEliminarSubItem("Se eliminará este registro por pagar.", () => coveTemporal.PreciosPorPagar.Remove(item))'>
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        @* TAB 4: COMPENSACIONES *@
                        <div class="@(tabActiva == 4 ? "d-block" : "d-none")">
                            <div class="p-3 bg-white rounded border mb-3 shadow-sm">
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-3"><label class="form-label small fw-bold text-muted">FECHA</label><InputDate class="form-control form-control-sm" @bind-Value="tempCompen.Fecha" /></div>
                                    <div class="col-md-7"><label class="form-label small fw-bold text-muted">MOTIVO</label><InputText class="form-control form-control-sm" @bind-Value="tempCompen.Motivo" /></div>
                                    <div class="col-md-2">
                                        <button type="button"
                                                class="btn btn-sm w-100 fw-bold @(compensacionEnEdicion != null ? "btn-warning text-dark" : "btn-primary")"
                                                @onclick="AgregarCompensacion">
                                            <i class="bi @(compensacionEnEdicion != null ? "bi-pencil-square" : "bi-plus-lg")"></i>
                                            @(compensacionEnEdicion != null ? "ACTUALIZAR" : "AGREGAR")
                                        </button>
                                    </div>

                                    @if (compensacionEnEdicion != null)
                                    {
                                        <div class="col-md-12 text-end mt-1 fade-in">
                                            <button type="button" class="btn btn-link btn-sm text-muted fst-italic py-0"
                                                    @onclick="() => { compensacionEnEdicion = null; tempCompen = new(); }">
                                                <i class="bi bi-x-circle"></i> Cancelar Edición
                                            </button>
                                        </div>
                                    }
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">FORMA PAGO *</label>
                                        <InputSelect class="form-select form-select-sm" @bind-Value="tempCompen.TipoPago">
                                            <option value="">-- Seleccione --</option>
                                            @foreach (var fp in ListaFormasPago)
                                            {
                                                <option value="@fp.Clave">@fp.Clave - @fp.Descripcion</option>
                                            }
                                        </InputSelect>
                                        @if (tempCompen.TipoPago == "FORPAG.OT")
                                        {
                                            <div class="col-md-12 mt-2 fade-in">
                                                <label class="form-label small fw-bold text-muted">ESPECIFIQUE *</label>
                                                <InputText class="form-control form-control-sm"
                                                           @bind-Value="tempCompen.DescripcionOtroPago"
                                                           placeholder="Escriba el detalle del pago..." />
                                            </div>
                                        }
                                    </div>
                                    
                                    <div class="col-md-6"><label class="form-label small fw-bold text-muted">PRESTACIÓN MERCANCÍA</label><InputText class="form-control form-control-sm" @bind-Value="tempCompen.PrestacionMercancia" /></div>
                                </div>
                            </div>
                            <div class="table-responsive border rounded bg-white">
                                <table class="table table-sm table-striped table-hover mb-0 small">
                                    <thead class="table-light text-uppercase text-muted" style="font-size:0.75rem;"><tr><th class="py-2">Fecha</th><th class="py-2">Motivo</th><th class="py-2">Prestación</th><th class="py-2">Tipo Pago</th><th class="text-center py-2">Acción</th></tr></thead>
                                    <tbody>
                                        @foreach (var item in coveTemporal.Compensaciones)
                                        {
                                            <tr>
                                                <td>@item.Fecha?.ToShortDateString()</td>
                                                <td>@item.Motivo</td>
                                                <td>@item.PrestacionMercancia</td>
                                                <td>
                                                    @item.TipoPago
                                                    @if (!string.IsNullOrEmpty(item.DescripcionOtroPago))
                                                    {
                                                        <span class="text-muted fst-italic ms-1">(@item.DescripcionOtroPago)</span>
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-link text-primary p-0 me-2"
                                                            @onclick="() => EditarCompensacion(item)" title="Editar">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>

                                                    <button type="button" class="btn btn-link text-danger p-0"
                                                            @onclick='() => ConfirmarEliminarSubItem("Se eliminará esta compensación.", () => coveTemporal.Compensaciones.Remove(item))'>
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        @* TAB 5: CONCEPTOS *@
                        <div class="@(tabActiva == 5 ? "d-block" : "d-none")">

                            @* INCREMENTABLES *@
                            <div class="card shadow-sm border-0 mb-4">
                                <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-plus-circle-fill"></i>
                                        <h6 class="mb-0 fw-bold text-uppercase">Incrementables</h6>
                                    </div>
                                    <span class="badge bg-white text-primary rounded-pill">@coveTemporal.Incrementables.Count</span>
                                </div>
                                <div class="card-body bg-white">
                                    <div class="row g-2 align-items-end mb-3 border bg-light p-3 rounded">
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold text-muted">TIPO</label>
                                            <InputSelect class="form-select form-select-sm" @bind-Value="tempIncre.TipoIncrementable">
                                                <option value="">-- Seleccione --</option>
                                                @foreach (var i in ListaIncrementables)
                                                {
                                                    <option value="@i.Clave">@i.Clave - @i.Descripcion</option>
                                                }
                                            </InputSelect>
                                        </div>
                                        <div class="col-md-2"><label class="form-label small fw-bold text-muted">FECHA</label><InputDate class="form-control form-control-sm" @bind-Value="tempIncre.FechaErogacion" /></div>
                                        <div class="col-md-2"><label class="form-label small fw-bold text-muted">IMPORTE</label><InputNumber class="form-control form-control-sm" @bind-Value="tempIncre.Importe" /></div>
                                        <div class="col-md-1">
                                            <label class="form-label small fw-bold text-muted">MONEDA</label>
                                            <InputSelect class="form-select form-select-sm" @bind-Value="tempIncre.TipoMoneda">
                                                <option value="">-- Selecione --</option>
                                                @foreach (var m in ListaMonedas)
                                                {
                                                    <option value="@m.Clave">@m.Clave - @m.Descripcion</option>
                                                }
                                            </InputSelect>
                                        </div>
                                        <div class="col-md-1"><label class="form-label small fw-bold text-muted">T.C.</label><InputNumber class="form-control form-control-sm" @bind-Value="tempIncre.TipoCambio" /></div>
                                        <div class="col-md-1 text-center">
                                            <label class="form-label small fw-bold text-muted d-block" style="font-size:0.7rem">CARGO IMP.</label>
                                            <InputCheckbox class="form-check-input" @bind-Value="TempIncreACargoImportador" />
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button"
                                                    class="btn btn-sm w-100 fw-bold @(incrementableEnEdicion != null ? "btn-warning text-dark" : "btn-primary")"
                                                    @onclick="AgregarIncrementable">
                                                <i class="bi @(incrementableEnEdicion != null ? "bi-pencil-square" : "bi-plus-lg")"></i>
                                                @(incrementableEnEdicion != null ? "ACTUALIZAR" : "AGREGAR")
                                            </button>
                                        </div>

                                        @* Botón Cancelar (aparece solo al editar) *@
                                        @if (incrementableEnEdicion != null)
                                        {
                                            <div class="col-md-12 text-end mt-1">
                                                <button type="button" class="btn btn-link btn-sm text-muted"
                                                        @onclick="() => { incrementableEnEdicion = null; tempIncre = new() { TipoMoneda = string.Empty, TipoCambio = 1 }; }">
                                                    Cancelar Edición
                                                </button>
                                            </div>
                                        }
                                    </div>
                                    @if (coveTemporal.Incrementables.Any())
                                    {
                                        <div class="table-responsive border rounded">
                                            <table class="table table-sm table-striped table-hover mb-0 small">
                                                <thead class="table-light text-uppercase text-muted" style="font-size:0.75rem;">
                                                    <tr><th class="py-2">Tipo</th><th class="py-2">Fecha</th><th class="text-end py-2">Importe</th><th class="text-center py-2">Moneda</th><th class="text-end py-2">T.C.</th><th class="text-center py-2">Cargo Imp.</th><th class="text-center py-2">Acción</th></tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var inc in coveTemporal.Incrementables)
                                                    {
                                                        <tr>
                                                            <td>@inc.TipoIncrementable</td>
                                                            <td>@inc.FechaErogacion?.ToShortDateString()</td>
                                                            <td class="text-end">@inc.Importe.ToString("N2")</td>
                                                            <td class="text-center">@inc.TipoMoneda</td>
                                                            <td class="text-end">@inc.TipoCambio</td>
                                                            <td class="text-center">@(inc.ACargoImportador == true ? "SÍ" : "NO")</td>
                                                            <td class="text-center">
                                                                @* EDITAR *@
                                                                <button type="button" class="btn btn-link text-primary p-0 me-2"
                                                                        @onclick="() => EditarIncrementable(inc)">
                                                                    <i class="bi bi-pencil"></i>
                                                                </button>

                                                                @* ELIMINAR (El que ya tenías mejorado) *@
                                                                <button type="button" class="btn btn-link text-danger p-0"
                                                                        @onclick='() => ConfirmarEliminarSubItem("Se quitará el incrementable.", () => coveTemporal.Incrementables.Remove(inc))'>
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                </div>
                            </div>

                            @* DECREMENTABLES *@
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-dash-circle-fill"></i>
                                        <h6 class="mb-0 fw-bold text-uppercase">Decrementables</h6>
                                    </div>
                                    <span class="badge bg-white text-primary rounded-pill">@coveTemporal.Decrementables.Count</span>
                                </div>
                                <div class="card-body bg-white">
                                    <div class="row g-2 align-items-end mb-3 border bg-light p-3 rounded">
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold text-muted">TIPO</label>
                                            <InputSelect class="form-select form-select-sm" @bind-Value="tempDecre.TipoIncrementable">
                                                <option value="">-- Seleccione --</option>
                                                @foreach (var i in ListaDecrementables)
                                                {
                                                    <option value="@i.Clave">@i.Clave - @i.Descripcion</option>
                                                }
                                            </InputSelect>
                                        </div>
                                        <div class="col-md-2"><label class="form-label small fw-bold text-muted">FECHA</label><InputDate class="form-control form-control-sm" @bind-Value="tempDecre.FechaErogacion" /></div>
                                        <div class="col-md-2"><label class="form-label small fw-bold text-muted">IMPORTE</label><InputNumber class="form-control form-control-sm" @bind-Value="tempDecre.Importe" /></div>
                                        <div class="col-md-1">
                                            <label class="form-label small fw-bold text-muted">MONEDA</label>
                                            <InputSelect class="form-select form-select-sm" @bind-Value="tempDecre.TipoMoneda">
                                                <option value="">-- Selecione --</option>
                                                @foreach (var m in ListaMonedas)
                                                {
                                                    <option value="@m.Clave">@m.Clave - @m.Descripcion</option>
                                                }
                                            </InputSelect>
                                        </div>
                                        <div class="col-md-1"><label class="form-label small fw-bold text-muted">T.C.</label><InputNumber class="form-control form-control-sm" @bind-Value="tempDecre.TipoCambio" /></div>
                                        <div class="col-md-2">
                                            <button type="button"
                                                    class="btn btn-sm w-100 fw-bold @(decrementableEnEdicion != null ? "btn-warning text-dark" : "btn-primary")"
                                                    @onclick="AgregarDecrementable">
                                                <i class="bi @(decrementableEnEdicion != null ? "bi-pencil-square" : "bi-plus-lg")"></i>
                                                @(decrementableEnEdicion != null ? "ACTUALIZAR" : "AGREGAR")
                                            </button>
                                        </div>

                                        @if (decrementableEnEdicion != null)
                                        {
                                            <div class="col-md-12 text-end mt-1">
                                                <button type="button" class="btn btn-link btn-sm text-muted"
                                                        @onclick="() => { decrementableEnEdicion = null; tempDecre = new() { TipoMoneda = string.Empty, TipoCambio = 1 }; }">
                                                    Cancelar Edición
                                                </button>
                                            </div>
                                        }
                                    </div>

                                    @if (coveTemporal.Decrementables.Any())
                                    {
                                        <div class="table-responsive border rounded">
                                            <table class="table table-sm table-striped table-hover mb-0 small">
                                                <thead class="table-light text-uppercase text-muted" style="font-size:0.75rem;">
                                                    <tr><th class="py-2">Tipo</th><th class="py-2">Fecha</th><th class="text-end py-2">Importe</th><th class="text-center py-2">Moneda</th><th class="text-end py-2">T.C.</th><th class="text-center py-2">Acción</th></tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var dec in coveTemporal.Decrementables)
                                                    {
                                                        <tr>
                                                            <td>@dec.TipoIncrementable</td>
                                                            <td>@dec.FechaErogacion?.ToShortDateString()</td>
                                                            <td class="text-end">@dec.Importe.ToString("N2")</td>
                                                            <td class="text-center">@dec.TipoMoneda</td>
                                                            <td class="text-end">@dec.TipoCambio</td>
                                                            <td class="text-center">
                                                                @* EDITAR *@
                                                                <button type="button" class="btn btn-link text-primary p-0 me-2"
                                                                        @onclick="() => EditarDecrementable(dec)">
                                                                    <i class="bi bi-pencil"></i>
                                                                </button>

                                                                @* ELIMINAR *@
                                                                <button type="button" class="btn btn-link text-danger p-0"
                                                                        @onclick='() => ConfirmarEliminarSubItem("Se quitará el decrementable.", () => coveTemporal.Decrementables.Remove(dec))'>
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                    </EditForm>
                </div>
                @* FOOTER DEL MODAL *@
                <div class="modal-footer bg-light border-top-0">
                    <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="CerrarModal">Cancelar</button>
                    <button type="submit" class="btn btn-primary btn-sm fw-bold px-4" @onclick="GuardarCoveEnLista"><i class="bi bi-save"></i> GUARDAR COVE</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int? Id { get; set; }

    //seguridad de campos
    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; }

    // 2. VARIABLE DE CONTROL
    private bool bloquearCamposAA = false;

    // MODELO PRINCIPAL (Ya sin TipoOperacion)
    private CrearManifestacionDto manifestacion = new CrearManifestacionDto();

    // Variables de Estado
    private bool mostrarModal = false;
    private int tabActiva = 1;
    private CoveDetalleDto? coveEnEdicion = null;
    private CoveDetalleDto coveTemporal = new CoveDetalleDto();
    private int clienteSeleccionadoId = 0;
    // Temporales para Agregar Items
    private PrecioPagadoDto tempPagado = new();
    private PrecioPorPagarDto tempPorPagar = new();
    private CompensacionDto tempCompen = new();
    private ConceptoValorDto tempIncre = new();
    private ConceptoValorDto tempDecre = new();
    private ConsultaRfcDto tempRfc = new();
    private List<ClienteDto> ListaMisClientes = new();
    // Proxy para el Checkbox (Soluciona error bool?)
    private bool TempIncreACargoImportador
    {
        get => tempIncre.ACargoImportador ?? false;
        set => tempIncre.ACargoImportador = value;
    }

    // Catálogos
    private List<CatalogoDto> ListaIncoterms = new();
    private List<CatalogoDto> ListaMetodosValoracion = new();
    private List<CatalogoDto> ListaFormasPago = new();
    private List<CatalogoDto> ListaIncrementables = new();
    private List<CatalogoDto> ListaDecrementables = new();
    private List<CatalogoDto> ListaTiposFigura = new();
    private List<CatalogoDto> ListaMonedas = new();
    private string defaultPatente = "";
    private string defaultAduana = "";
    //variables para controlar la edicion
    private PrecioPagadoDto? pagadoEnEdicion = null;
    private PrecioPorPagarDto? porPagarEnEdicion = null;
    private CompensacionDto? compensacionEnEdicion = null;
    private ConceptoValorDto? incrementableEnEdicion = null;
    private ConceptoValorDto? decrementableEnEdicion = null;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateTask;
        var user = authState.User;

        if (user.IsInRole("Cliente"))
        {
            bloquearCamposAA = true;
        }
        // 1. Carga inicial de catálogos, clientes y datos default
        await CargarCatalogos();
        await CargarClietes();

        await CargarDatosDefault();
        ResetTemporales();
    }

    private async Task CargarClietes()
    {
        try
        {
            ListaMisClientes = await Http.GetFromJsonAsync<List<ClienteDto>>("api/clientes/mis-clientes");
        }
        catch (Exception ex)
        {
            await MostrarToast("Error cargando clientes: " + ex.Message, SweetAlertIcon.Error);
        }
    }

    private void OnClienteSeleccionado(int id)
    {
        clienteSeleccionadoId = id;

        if (id > 0)
        {
            // Buscamos el objeto completo en la lista memoria
            var cliente = ListaMisClientes.FirstOrDefault(c => c.ClienteId == id);
            if (cliente != null)
            {
                // Asignamos al modelo de la manifestación
                manifestacion.ClienteId = cliente.ClienteId;
                manifestacion.Cliente = cliente; // Para que se vea el RFC en el input readonly

                // Opcional: Llenar otros datos automáticos (Dirección, etc.)
            }
        }
    }

    private async Task CargarDatosDefault()
    {
        try
        {

            var defaults = await Http.GetFromJsonAsync<JsonElement>("api/DefaultValores");
            if (defaults.TryGetProperty("patente", out var p)) defaultPatente = p.GetString() ?? "";
            if (defaults.TryGetProperty("aduana", out var a)) defaultAduana = a.GetString() ?? "";

            if (Id.HasValue)
            {
                // Si es EDICIÓN (tiene ID en la URL)
                await CargarExpediente(Id.Value);
            }
            else
            {
                // Si es NUEVO (Id es null), cargamos el default desde tu nuevo controlador
           


                    var rfc = defaults.GetProperty("rfc").GetString();
                    var nombre = defaults.GetProperty("nombre").GetString();
                    var figura = defaults.GetProperty("figura").GetString();


                    if (!string.IsNullOrEmpty(rfc))
                    {
                        manifestacion.Consultas.Add(new ConsultaRfcDto
                        {
                            RfcConsulta = rfc,
                            TipoFigura = figura

                        });
                    }
                }
           
            }
        catch (Exception ex)
        {
            Console.WriteLine("Nota: No se cargaron defaults (puede que no estén configurados). " + ex.Message);
        }
    }

    private async Task CargarCatalogos()
    {
        var t1 = CargarCat("api/catalogos/incoterms", l => ListaIncoterms = l);
        var t2 = CargarCat("api/catalogos/metodos-valoracion", l => ListaMetodosValoracion = l);
        var t3 = CargarCat("api/catalogos/formas-pago", l => ListaFormasPago = l);
        var t4 = CargarCat("api/catalogos/incrementables", l => ListaIncrementables = l);
        var t5 = CargarCat("api/catalogos/decrementables", l => ListaDecrementables = l);
        var t6 = CargarCat("api/catalogos/tipos-figura", l => ListaTiposFigura = l);
        var t7 = CargarCat("api/catalogos/monedas", l => ListaMonedas = l);
        await Task.WhenAll(t1, t2, t3, t4, t5, t6,t7);
    }

    private async Task CargarCat(string url, Action<List<CatalogoDto>> setter) { try { var r = await Http.GetFromJsonAsync<List<CatalogoDto>>(url); if (r != null) setter(r); } catch { } }

    private async Task CargarExpediente(int id)
    {
        try
        {
            var res = await Http.GetFromJsonAsync<ManifestacionDto>($"api/ManifestacionesValor/{id}");
            if (res != null)
            {
                // === MAPEO DE DATOS GENERALES ===
                manifestacion.ReferenciaAdmin = res.NumeroPedimento;
                manifestacion.Referencia = res.Referencia;
                manifestacion.RfcImportador = res.RfcImportador;

                // IMPORTANTE: Recuperar el Cliente seleccionado para el Dropdown
                // Asegúrate que tu ManifestacionDto en el BackEnd traiga esta propiedad 'ClienteId'
                if (res.ClienteId > 0)
                {
                    clienteSeleccionadoId = res.ClienteId; // Esto actualiza el <InputSelect>
                    manifestacion.ClienteId = res.ClienteId;

                    // Buscamos el objeto cliente completo para mostrar el RFC en el input readonly
                    manifestacion.Cliente = ListaMisClientes.FirstOrDefault(c => c.ClienteId == res.ClienteId);
                }

                // === MAPEO TOTALES ===
                manifestacion.TotalPrecioPagado = res.TotalPrecioPagado ?? 0;
                manifestacion.TotalPrecioPorPagar = res.TotalPrecioPorPagar ?? 0;
                manifestacion.TotalIncrementables = res.TotalIncrementables ?? 0;
                manifestacion.TotalDecrementables = res.TotalDecrementables ?? 0;
                manifestacion.TotalValorAduana = res.TotalValorAduana ?? 0;

                // === MAPEO CONSULTAS RFC ===
                manifestacion.Consultas = res.Consultas.Select(c => new ConsultaRfcDto
                {
                    RfcConsulta = c.RfcConsulta,
                    TipoFigura = c.TipoFigura
                }).ToList();

                // === MAPEO COVES (Tu código actual estaba bien aquí) ===
                manifestacion.Coves = res.ManifestacionCoves.Select(c => new CoveDetalleDto
                {
                    // Truco: Generamos un ID temporal para que el front no se pierda al editar
                    IdTemporal = Guid.NewGuid().ToString(),
                    CoveId = c.CoveId,
                    NumeroCove = c.NumeroCove,
                    Incoterm = c.Incoterm,
                    Aduana = c.Aduana ?? "",
                    Patente = c.Patente ?? "",
                    NumeroPedimento = c.NumeroPedimento,
                    ExisteVinculacion = c.ExisteVinculacion ?? false,
                    MetodoValoracion = c.MetodoValoracion,

                    PreciosPagados = c.PreciosPagados,
                    PreciosPorPagar = c.PreciosPorPagar,
                    Compensaciones = c.Compensaciones,

                    // Recuperar Incrementables y Decrementables separados
                    Incrementables = c.ConceptosValor?.Where(x => x.TipoConcepto == "INCREMENTABLE").Select(x => new ConceptoValorDto
                    {
                        TipoIncrementable = x.ClaveConcepto,
                        Importe = x.Importe,
                        TipoMoneda = x.TipoMoneda,
                        FechaErogacion = x.FechaErogacion,
                        TipoCambio = x.TipoCambio,
                        ACargoImportador = x.ACargoImportador
                    }).ToList() ?? new(),

                    Decrementables = c.ConceptosValor?.Where(x => x.TipoConcepto == "DECREMENTABLE").Select(x => new ConceptoValorDto
                    {
                        TipoIncrementable = x.ClaveConcepto,
                        Importe = x.Importe,
                        TipoMoneda = x.TipoMoneda,
                        FechaErogacion = x.FechaErogacion,
                        TipoCambio = x.TipoCambio
                    }).ToList() ?? new()
                }).ToList();
            }
        }
        catch (Exception ex)
        {
            await MostrarToast("No se pudo cargar: " + ex.Message, SweetAlertIcon.Error);
        }
    } 

    // === GESTIÓN DE LISTAS Y MODAL ===
    private void AgregarRfcConsulta()
    {
        if (!string.IsNullOrEmpty(tempRfc.RfcConsulta) && !string.IsNullOrEmpty(tempRfc.TipoFigura)) 
            {
                manifestacion.Consultas.Add(new ConsultaRfcDto
                {
                    RfcConsulta = tempRfc.RfcConsulta, TipoFigura = tempRfc.TipoFigura
                }
            );
            tempRfc = new();
            }
    }

    private void AbrirModalNuevo() 
    { 
        coveEnEdicion = null;
        coveTemporal = new CoveDetalleDto
        {
            Patente = defaultPatente, // Usamos la variable que cargamos al inicio
            Aduana = defaultAduana,

            // Inicializamos las listas para evitar errores
            PreciosPagados = new(),
            PreciosPorPagar = new(),
            Compensaciones = new(),
            Incrementables = new(),
            Decrementables = new()
        };
        ResetTemporales(); 
        tabActiva = 1;
        mostrarModal = true; 
    }

    private void CargarDatosParaEditar(CoveDetalleDto item)
    {
        coveEnEdicion = item; 
        var json = JsonSerializer.Serialize(item);
        coveTemporal = JsonSerializer.Deserialize<CoveDetalleDto>(json)!;
        ResetTemporales(); tabActiva = 1;
        mostrarModal = true;
    }

    private void CerrarModal() => mostrarModal = false;

    // private void GuardarCoveEnLista() { if (coveEnEdicion != null) { var i = manifestacion.Coves.IndexOf(coveEnEdicion); if (i != -1) manifestacion.Coves[i] = coveTemporal; } else { manifestacion.Coves.Add(coveTemporal); } CerrarModal(); }
    private async Task GuardarCoveEnLista()
    {
        // 1. Validaciones mínimas de UI
        if (string.IsNullOrEmpty(coveTemporal.NumeroCove))
        {
            await MostrarToast("El número de COVE es obligatorio.", SweetAlertIcon.Warning);
            return;
        }

        // Si el expediente NO existe aún (es nuevo y nunca se ha guardado),
        // no podemos guardar el COVE en BD porque no tiene papá.
        // En ese caso, mantenemos la lógica de memoria.
        if (!Id.HasValue)
        {
            // Lógica antigua (Solo memoria)
            if (coveEnEdicion != null)
            {
                var i = manifestacion.Coves.IndexOf(coveEnEdicion);
                if (i != -1) manifestacion.Coves[i] = coveTemporal;
            }
            else
            {
                manifestacion.Coves.Add(coveTemporal);
            }
            CerrarModal();
            await MostrarToast("COVE agregado (Guardar el expediente para confirmar en BD).", SweetAlertIcon.Info);
            return;
        }

        // 2. GUARDADO TRANSACCIONAL (Directo a BD)
        try
        {
            // Vinculamos con el expediente actual
            coveTemporal.ManifestacionId = Id.Value;

            HttpResponseMessage resp;
            bool esNuevo = coveTemporal.CoveId == 0;

            if (esNuevo)
            {
                // POST: Crear
                resp = await Http.PostAsJsonAsync("api/Coves", coveTemporal);
            }
            else
            {
                // PUT: Actualizar
                resp = await Http.PutAsJsonAsync($"api/Coves/{coveTemporal.CoveId}", coveTemporal);
            }

            if (resp.IsSuccessStatusCode)
            {
                await MostrarToast(esNuevo ? "COVE creado correctamente." : "COVE actualizado correctamente.", SweetAlertIcon.Success);

                // 3. CERRAR Y RECARGAR
                // Recargamos todo el expediente desde el servidor para traer los datos frescos
                // y asegurar que la tabla principal coincida con la BD.
                CerrarModal();
                await CargarExpediente(Id.Value);
            }
            else
            {
                var errorMsg = await resp.Content.ReadAsStringAsync();
                await MostrarToast("Error al guardar COVE: " + errorMsg, SweetAlertIcon.Error);
            }
        }
        catch (Exception ex)
        {
            await MostrarToast("Error de conexión: " + ex.Message, SweetAlertIcon.Error);
        }
    }
    //private void EliminarCove(CoveDetalleDto item) => manifestacion.Coves.Remove(item);

    private void AgregarPagado() 
    {
        if (tempPagado.TipoPago == "FORPAG.OT" && string.IsNullOrWhiteSpace(tempPagado.DescripcionOtroPago))
        {
            MostrarToast("Debe especificar el tipo de pago.", SweetAlertIcon.Warning);
            return;
        }
        if (tempPagado.Total == 0 || !tempPagado.FechaPago.HasValue || string.IsNullOrEmpty(tempPagado.TipoMoneda) || tempPagado.TipoCambio<=0 || string.IsNullOrEmpty(tempPagado.TipoPago) )
        {

            MostrarToast("Debes completar todos los campos", SweetAlertIcon.Warning);
            return;

        }
        if (pagadoEnEdicion != null)
        {
            // === MODO EDICIÓN: ACTUALIZAMOS EL EXISTENTE ===

            // Buscamos el objeto original en la lista y actualizamos sus valores
            pagadoEnEdicion.FechaPago = tempPagado.FechaPago;
            pagadoEnEdicion.Total = tempPagado.Total;
            pagadoEnEdicion.TipoMoneda = tempPagado.TipoMoneda;
            pagadoEnEdicion.TipoCambio = tempPagado.TipoCambio;
            pagadoEnEdicion.TipoPago = tempPagado.TipoPago;
            pagadoEnEdicion.DescripcionOtroPago = tempPagado.DescripcionOtroPago;

            MostrarToast("Pago actualizado correctamente", SweetAlertIcon.Success);

            // Importante: Soltamos la referencia para salir del modo edición
            pagadoEnEdicion = null;
        }
        else
        {
            // === MODO CREACIÓN: AGREGAMOS UNO NUEVO ===
            coveTemporal.PreciosPagados.Add(tempPagado);
            MostrarToast("Nuevo precio pagado agregado", SweetAlertIcon.Success);
        }

       
        tempPagado = new() 
        {
            TipoMoneda = "",
            TipoCambio = 0,
            FechaPago = null, 
            TipoPago = ""
        };

        
    }

    private void AgregarPorPagar()
    {
        if (tempPorPagar.TipoPago == "FORPAG.OT" && string.IsNullOrWhiteSpace(tempPorPagar.DescripcionOtroPago))
        {
            MostrarToast("Debe especificar el tipo de pago.", SweetAlertIcon.Warning);
            return;
        }
        if (!tempPorPagar.FechaPago.HasValue || tempPorPagar.Total <= 0 || string.IsNullOrEmpty(tempPorPagar.TipoMoneda) || tempPorPagar.TipoCambio == 0 || string.IsNullOrEmpty(tempPorPagar.TipoPago))
        {
            MostrarToast("Debes completar todos los campos", SweetAlertIcon.Warning);
            return;
        }

        if (porPagarEnEdicion != null)
        {
            // === MODO EDICIÓN: ACTUALIZAR ===
            porPagarEnEdicion.FechaPago = tempPorPagar.FechaPago;
            porPagarEnEdicion.Total = tempPorPagar.Total;
            porPagarEnEdicion.TipoMoneda = tempPorPagar.TipoMoneda;
            porPagarEnEdicion.TipoCambio = tempPorPagar.TipoCambio;
            porPagarEnEdicion.TipoPago = tempPorPagar.TipoPago;
            porPagarEnEdicion.SituacionNoFechaPago = tempPorPagar.SituacionNoFechaPago; // Campo único de Por Pagar
            porPagarEnEdicion.DescripcionOtroPago = tempPorPagar.DescripcionOtroPago;

            MostrarToast("Registro actualizado correctamente", SweetAlertIcon.Success);
            porPagarEnEdicion = null; // Salir modo edición
        }
        else
        {
          
            coveTemporal.PreciosPorPagar.Add(tempPorPagar);
            MostrarToast("Nuevo precio por pagar agregado", SweetAlertIcon.Success);
        }

        // 3. Limpiar formulario
        tempPorPagar = new()
        {
            FechaPago = null,
            Total = 0,
            TipoMoneda = "",
            TipoCambio = 0,
            TipoPago = "",
            SituacionNoFechaPago = "",
            DescripcionOtroPago = ""
        };

    }

    private void AgregarCompensacion()
    {
        if (tempCompen.TipoPago == "FORPAG.OT" && string.IsNullOrWhiteSpace(tempCompen.DescripcionOtroPago))
        {
            MostrarToast("Debe especificar el tipo de pago.", SweetAlertIcon.Warning);
            return;
        }
        if (!tempCompen.Fecha.HasValue || string.IsNullOrEmpty(tempCompen.Motivo) || string.IsNullOrEmpty(tempCompen.PrestacionMercancia) || string.IsNullOrEmpty(tempCompen.TipoPago))
        {
            MostrarToast("Debes completar todos los campos", SweetAlertIcon.Warning);
            return;
        }

        if (compensacionEnEdicion != null)
        {
            
            compensacionEnEdicion.Fecha = tempCompen.Fecha;
            compensacionEnEdicion.Motivo = tempCompen.Motivo;
            compensacionEnEdicion.PrestacionMercancia = tempCompen.PrestacionMercancia;
            compensacionEnEdicion.TipoPago = tempCompen.TipoPago;
            compensacionEnEdicion.DescripcionOtroPago = tempCompen.DescripcionOtroPago;

            MostrarToast("Compensación actualizada correctamente", SweetAlertIcon.Success);
            compensacionEnEdicion = null; // Salir modo edición
        }
        else
        {
            
            coveTemporal.Compensaciones.Add(tempCompen);
            MostrarToast("Nueva compensación agregada", SweetAlertIcon.Success);
        }

        // 3. Limpiar formulario
        tempCompen = new()
        {
            Fecha = DateTime.Now,
            TipoPago = "",
            PrestacionMercancia = "",
            Motivo = "",
            DescripcionOtroPago = ""
        };
    }

    private void AgregarIncrementable()
    { 
        if (tempIncre.Importe <= 0 || string.IsNullOrEmpty(tempIncre.TipoIncrementable))
        {
            MostrarToast("Tipo e importe son obligatorios", SweetAlertIcon.Warning); 
            return;
        }
        if (incrementableEnEdicion != null)
        {
            // === MODO EDICIÓN ===
            incrementableEnEdicion.TipoIncrementable = tempIncre.TipoIncrementable;
            incrementableEnEdicion.FechaErogacion = tempIncre.FechaErogacion;
            incrementableEnEdicion.Importe = tempIncre.Importe;
            incrementableEnEdicion.TipoMoneda = tempIncre.TipoMoneda;
            incrementableEnEdicion.TipoCambio = tempIncre.TipoCambio;
            incrementableEnEdicion.ACargoImportador = TempIncreACargoImportador;

            MostrarToast("Incrementable actualizado", SweetAlertIcon.Success);
            incrementableEnEdicion = null; // Salir de edición
        }
        else
        {
            // === MODO CREACIÓN ===
            coveTemporal.Incrementables.Add(tempIncre);
            MostrarToast("Incrementable agregado", SweetAlertIcon.Success);
        }

        // Limpiar
        tempIncre = new() { TipoMoneda = "MXN", TipoCambio = 1, FechaErogacion = DateTime.Now, ACargoImportador = false };
        TempIncreACargoImportador = false;
    }

    private void AgregarDecrementable()
    {
        if (tempDecre.Importe <= 0 || string.IsNullOrEmpty(tempDecre.TipoIncrementable))
        {
            MostrarToast("Tipo e importe son obligatorios", SweetAlertIcon.Warning);
            return;
        }

        if (decrementableEnEdicion != null)
        {
            // === EDICIÓN ===
            decrementableEnEdicion.TipoIncrementable = tempDecre.TipoIncrementable;
            decrementableEnEdicion.FechaErogacion = tempDecre.FechaErogacion;
            decrementableEnEdicion.Importe = tempDecre.Importe;
            decrementableEnEdicion.TipoMoneda = tempDecre.TipoMoneda;
            decrementableEnEdicion.TipoCambio = tempDecre.TipoCambio;

            MostrarToast("Decrementable actualizado", SweetAlertIcon.Success);
            decrementableEnEdicion = null;
        }
        else
        {
            // === CREACIÓN ===
            coveTemporal.Decrementables.Add(tempDecre);
            MostrarToast("Decrementable agregado", SweetAlertIcon.Success);
        }

        tempDecre = new() { TipoMoneda = "MXN", TipoCambio = 1, FechaErogacion = DateTime.Now };
    }

    private void ResetTemporales()
    {
        tempPagado = new() { TipoMoneda = "", TipoCambio = 0, FechaPago = null, TipoPago = "" };
        tempPorPagar = new() { TipoMoneda = "", TipoCambio = 0, TipoPago = "", SituacionNoFechaPago = "" };
        tempCompen = new() { Fecha = null, TipoPago = "", PrestacionMercancia = "" };
        tempIncre = new() { TipoMoneda = "", TipoCambio = 0, FechaErogacion =null, ACargoImportador = false };
        tempDecre = new() { TipoMoneda = "", TipoCambio = 0, FechaErogacion = null };
        tempRfc = new();

    }

    private async Task GuardarTodo()
    {
        if (string.IsNullOrEmpty(manifestacion.ReferenciaAdmin))
        {
            await MostrarToast("Falta el Número de Pedimento.", SweetAlertIcon.Warning); return;
        }
        // 2. AUTO-DETECCIÓN DE ESTADO
        // Definimos las reglas para considerar un expediente "TERMINADO"
        bool tieneCliente = manifestacion.ClienteId > 0;
        bool tieneCoves = manifestacion.Coves.Count > 0;
        bool tieneTotales = manifestacion.TotalValorAduana > 0;

        // Evaluamos
        if (tieneCliente && tieneCoves && tieneTotales)
        {
            manifestacion.EstadoEnvio = "COMPLETO";
        }
        else
        {
            manifestacion.EstadoEnvio = "BORRADOR";
        }
        try
        {
            HttpResponseMessage resp;
            if (Id.HasValue) resp = await Http.PutAsJsonAsync($"api/ManifestacionesValor/{Id}", manifestacion);
            else resp = await Http.PostAsJsonAsync("api/ManifestacionesValor", manifestacion);

            if (resp.IsSuccessStatusCode)
            {
                if (manifestacion.EstadoEnvio == "COMPLETO")
                {
                    await MostrarToast("¡Expediente Finalizado Correctamente!", SweetAlertIcon.Success);
                }
                else
                {
                    // Le decimos sutilmente que se guardó, pero sigue pendiente
                    string faltantes = "";
                    if (!tieneCoves) faltantes += "COVEs, ";
                    if (!tieneTotales) faltantes += "Totales, ";

                    await MostrarToast($"Guardado como BORRADOR. (Falta: {faltantes.TrimEnd(',', ' ')})", SweetAlertIcon.Info);
                }
                NavManager.NavigateTo("/manifestaciones");
            }
            else
            {
                var err = await resp.Content.ReadAsStringAsync();
                await MostrarToast("Error al guardar"+err, SweetAlertIcon.Error);
            }
        }
        catch (Exception ex) { await MostrarToast("Error: "+ex.Message, SweetAlertIcon.Error); }
    }

    private void EditarPagado(PrecioPagadoDto item)
    {
        // 1. Guardamos la referencia para saber cuál vamos a actualizar
        pagadoEnEdicion = item;

        // 2. Copiamos los datos al formulario (tempPagado)
        // Usamos 'new' para crear una copia y no modificar la tabla en tiempo real mientras escribes
        tempPagado = new PrecioPagadoDto
        {
            FechaPago = item.FechaPago,
            Total = item.Total,
            TipoMoneda = item.TipoMoneda,
            TipoCambio = item.TipoCambio,
            TipoPago = item.TipoPago,
            DescripcionOtroPago = item.DescripcionOtroPago
        };
    }

    private void EditarPorPagar(PrecioPorPagarDto item)
    {
        porPagarEnEdicion = item;
        tempPorPagar = new PrecioPorPagarDto
        {
            FechaPago = item.FechaPago,
            Total = item.Total,
            TipoMoneda = item.TipoMoneda,
            TipoCambio = item.TipoCambio,
            TipoPago = item.TipoPago,
            SituacionNoFechaPago = item.SituacionNoFechaPago,
            DescripcionOtroPago = item.DescripcionOtroPago
        };

    }
    
    private void EditarCompensacion(CompensacionDto item)
    {
        compensacionEnEdicion = item;
        tempCompen = new CompensacionDto
        {
            Fecha = item.Fecha,
            Motivo = item.Motivo,
            TipoPago = item.TipoPago,
            PrestacionMercancia = item.PrestacionMercancia,
            DescripcionOtroPago = item.DescripcionOtroPago
        };

    }

    private void EditarIncrementable(ConceptoValorDto item)
    {
        incrementableEnEdicion = item;

        // Clonamos los datos al temporal
        tempIncre = new ConceptoValorDto
        {
            TipoIncrementable = item.TipoIncrementable,
            FechaErogacion = item.FechaErogacion,
            Importe = item.Importe,
            TipoMoneda = item.TipoMoneda,
            TipoCambio = item.TipoCambio,
            ACargoImportador = item.ACargoImportador
        };

        // Actualizamos el Proxy del Checkbox
        TempIncreACargoImportador = item.ACargoImportador ?? false;
    }
    
    private void EditarDecrementable(ConceptoValorDto item)
    {
        decrementableEnEdicion = item;
        tempDecre = new ConceptoValorDto
        {
            TipoIncrementable = item.TipoIncrementable,
            FechaErogacion = item.FechaErogacion,
            Importe = item.Importe,
            TipoMoneda = item.TipoMoneda,
            TipoCambio = item.TipoCambio
        };
    }
    // 1. ELIMINAR COVE (Transaccional)
    private async Task ConfirmarEliminarCove(CoveDetalleDto item)
    {
        var result = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "¿Estás seguro?",
            Text = $"Se eliminará el COVE {item.NumeroCove} permanentemente.",
            Icon = SweetAlertIcon.Warning,
            ShowCancelButton = true,
            ConfirmButtonText = "Si",
            CancelButtonText = "Cancelar"
        });

        if (result.IsConfirmed)
        {
            if (item.CoveId > 0 && Id.HasValue) // Si ya existe en BD
            {
                try
                {
                    var resp = await Http.DeleteAsync($"api/Coves/{item.CoveId}");
                    if (resp.IsSuccessStatusCode)
                    {
                        await MostrarToast("COVE eliminado de forma permanente.", SweetAlertIcon.Success);
                        await CargarExpediente(Id.Value); // Recargamos para refrescar la tabla
                    }
                    else
                    {
                        await MostrarToast("Error al eliminar en servidor.", SweetAlertIcon.Error);
                    }
                }
                catch (Exception ex) { await MostrarToast("Error: " + ex.Message, SweetAlertIcon.Error); }
            }
            else // Si es temporal (aún no guardado en BD)
            {
                manifestacion.Coves.Remove(item);
                await MostrarToast("COVE eliminado de la lista.", SweetAlertIcon.Success);
            }
        }
    }

   
    private async Task ConfirmarEliminarSubItem(string titulo, Action borrarAccion)
    {
        var result = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "¿Quitar registro?",
            Text = titulo, // Ej: "Se quitará este pago de la lista"
            Icon = SweetAlertIcon.Question, // Icono menos agresivo para items temporales
            ShowCancelButton = true,
            ConfirmButtonText = "Sí, quitar",
            CancelButtonText = "No"
        });

        if (result.IsConfirmed)
        {
            borrarAccion.Invoke(); // Ejecuta la línea de código que borra
                                   // No mostramos Toast aquí para no saturar, o uno muy discreto
        }
    }
    private async Task MostrarToast(string mensaje, SweetAlertIcon icono)
    {
        await Swal.FireAsync(new SweetAlertOptions
        {
            Toast = true,                 // Activa el modo Toast (pequeño)
            Position = SweetAlertPosition.TopEnd, // Ubicación superior derecha
            ShowConfirmButton = false,    // Sin botón de "OK"
            Timer = 4000,                 // Desaparece a los 3 segundos
            Icon = icono,
            Title = mensaje,
           
        });
    }

    public class CatalogoDto { public string Clave { get; set; } = ""; public string Descripcion { get; set; } = ""; }
}