@page "/manifestaciones/nueva"
@page "/manifestaciones/editar/{Id:int}" 
@using SistemaAduanero.Shared.DTOs
@inject SweetAlertService Swal
@inject HttpClient Http
@inject NavigationManager NavManager
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using System.Text.Json
@attribute [Authorize]

<div class="container mt-4">
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Nuevo Expediente de Valor</h4>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Referencia Administrativa / Pedimento</label>
                    <InputText class="form-control" @bind-Value="manifestacion.ReferenciaAdmin" placeholder="Ej: IMP-2025-001 o 5023720" />
                    <small class="text-muted">Identificador principal de este expediente.</small>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Tipo Operación</label>
                    <select class="form-select" @bind="manifestacion.TipoOperacion">
                        <option value="I">Importación</option>
                        <option value="E">Exportación</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-outline-success w-100" @onclick="GuardarTodo">
                       <i class="bi bi-floppy"></i> Guardar Expediente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="text-secondary m-0">Documentos COVE / Facturas</h5>
            <button class="btn btn-primary" @onclick="AbrirModalNuevo">
                <i class="bi bi-plus-circle"></i> Agregar COVE
            </button>
        </div>
        <div class="card-body p-0">
            @if (manifestacion.Coves.Count == 0)
            {
                <div class="text-center p-5 text-muted">
                    <p>No hay COVEs registrados en este expediente.</p>
                    <small>Haz clic en "Agregar COVE" para capturar la información del XML.</small>
                </div>
            }
            else
            {
                <table class="table table-striped table-hover shadow-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>COVE (E-Doc)</th>
                            <th>Pedimento</th>
                            <th>Aduana/Patente</th>
                            <th>Fecha Pago</th>
                            <th class="text-end">Valor Aduana</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in manifestacion.Coves)
                        {
                            <tr>
                                <td>@item.NumeroCove</td>

                                <td>@item.NumeroPedimento</td>

                                <td>@(item.Aduana) / @(item.Patente)</td>

                                <td>@(item.FechaPago.ToShortDateString() ?? "-")</td>

                                <td>@item.TotalValorAduana.ToString("C2", System.Globalization.CultureInfo.CreateSpecificCulture("es-MX"))</td>


                                <td class="text-center">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-primary"
                                                @onclick="() => CargarDatosParaEditar(item)"
                                                title="Editar COVE">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>

                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                                @onclick="() => EliminarCove(item)"
                                                title="Eliminar">
                                            <i class="bi bi-trash3-fill"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>
</div>

@if (mostrarModal)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">Detalle del COVE (Captura XML)</h5>
                    <button type="button" class="btn-close" @onclick="CerrarModal"></button>
                </div>

                <div class="modal-body">
                    <EditForm Model="@coveTemporal" OnValidSubmit="GuardarCoveEnLista">
                        <DataAnnotationsValidator />

                        <ul class="nav nav-tabs mb-3">
                            <li class="nav-item">
                                <button class="nav-link @(tabActiva == 1 ? "active" : "")" type="button" @onclick="() => tabActiva = 1">
                                    📄 Datos Generales
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link @(tabActiva == 2 ? "active" : "")" type="button" @onclick="() => tabActiva = 2">
                                    💰 Incrementables (@coveTemporal.Incrementables.Count)
                                </button>
                            </li>
                        </ul>

                        <div class="@(tabActiva == 1 ? "d-block" : "d-none")">
                            <div class="row g-3">
                                <div class="col-md-4 border-end">
                                    <h6 class="text-primary border-bottom pb-2">Identificadores</h6>
                                    <label class="form-label mt-2">Número COVE *</label>
                                    <InputText class="form-control" @bind-Value="coveTemporal.NumeroCove" placeholder="Ej: COVE257..." />

                                    <label class="form-label mt-2">Incoterm</label>
                                    <InputSelect class="form-select" @bind-Value="coveTemporal.Incoterm">
                                        <option value="">-- Seleccione --</option>
                                        @foreach (var item in ListaIncoterms)
                                        {
                                            @* Mostramos "CLAVE - DESCRIPCION" para que sea claro *@
                                            <option value="@item.Clave">@item.Clave - @item.Descripcion</option>
                                        }
                                    </InputSelect>

                                    <label class="form-label mt-2">Vinculación</label>
                                    <InputSelect class="form-select" @bind-Value="coveTemporal.ExisteVinculacion">
                                        <option value="false">NO</option>
                                        <option value="true">SÍ</option>
                                    </InputSelect>

                                    <label class="form-label mt-2">M. Valoración</label>
                                    <InputSelect class="form-select" @bind-Value="coveTemporal.MetodoValoracion">
                                        <option value="">-- Seleccione --</option>
                                        @foreach (var item in ListaMetodosValoracion)
                                        {
                                            <option value="@item.Clave">@item.Clave - @item.Descripcion</option>
                                        }
                                    </InputSelect>

                                </div>

                                <div class="col-md-4 border-end">
                                    <h6 class="text-primary border-bottom pb-2">Pedimento y Pago</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="mt-2 small">Pedimento</label>
                                            <InputText class="form-control" @bind-Value="coveTemporal.NumeroPedimento" />
                                        </div>
                                        <div class="col-3">
                                            <label class="mt-2 small">Aduana</label>
                                            <InputNumber class="form-control" @bind-Value="coveTemporal.Aduana" />
                                        </div>
                                        <div class="col-3">
                                            <label class="mt-2 small">Patente</label>
                                            <InputNumber class="form-control" @bind-Value="coveTemporal.Patente" />
                                        </div>
                                    </div>
                                    <label class="form-label mt-3 fw-bold">Datos de Pago</label>
                                    <div class="row">
                                        <div class="col-6"><label class="small">Fecha</label><InputDate class="form-control form-control-sm" @bind-Value="coveTemporal.FechaPago" /></div>

                                        <div class="col-6">
                                            <label class="small">T. Pago</label>
                                            <InputSelect class="form-select form-select-sm" @bind-Value="coveTemporal.TipoPago">
                                                <option value="">-- Seleccione --</option>
                                                @foreach (var item in ListaFormasPago)
                                                {
                                                    <option value="@item.Clave">@item.Clave - @item.Descripcion</option>
                                                }
                                            </InputSelect>
                                        </div>

                                        <div class="col-4 mt-2"><label class="small">Moneda</label><InputText class="form-control form-control-sm" @bind-Value="coveTemporal.MonedaPago" /></div>
                                        <div class="col-4 mt-2"><label class="small">TC</label><InputNumber class="form-control form-control-sm" @bind-Value="coveTemporal.TipoCambioPago" /></div>
                                        <div class="col-4 mt-2"><label class="small">Total</label><InputNumber class="form-control form-control-sm" @bind-Value="coveTemporal.TotalPago" /></div>
                                    </div>
                                </div>

                                <div class="col-md-4 bg-light p-3 rounded">
                                    <h6 class="text-primary border-bottom pb-2">Totales (Valor Aduana)</h6>
                                    <label class="small mt-2">Precio Pagado</label>
                                    <InputNumber class="form-control" @bind-Value="coveTemporal.TotalPrecioPagado" />

                                    <label class="small mt-2">Incrementables (+)</label>
                                    <InputNumber class="form-control text-primary" @bind-Value="coveTemporal.TotalIncrementables" />

                                    <label class="small mt-2">Decrementables (-)</label>
                                    <InputNumber class="form-control text-danger" @bind-Value="coveTemporal.TotalDecrementables" />

                                    <hr />
                                    <label class="fw-bold">TOTAL VALOR ADUANA</label>
                                    <InputNumber class="form-control fw-bold fs-5" @bind-Value="coveTemporal.TotalValorAduana" />
                                </div>
                            </div>
                        </div>

                        <div class="@(tabActiva == 2 ? "d-block" : "d-none")">

                            <div class="card bg-light border-0 p-3 mb-3">
                                <div class="row g-2 align-items-end">

                                    <div class="col-md-3">
                                        <label class="small">Incrementable</label>
                                        <InputSelect class="form-select form-select-sm" @bind-Value="tempIncre.TipoIncrementable">
                                            <option value="">-- Seleccione --</option>
                                            @foreach (var item in ListaIncrementables)
                                            {
                                                <option value="@item.Clave">@item.Clave - @item.Descripcion</option>
                                            }
                                        </InputSelect>
                                    </div>

                                    
                                    <div class="col-md-3">
                                        <label class="small">Fecha Erogación</label>
                                        <InputDate class="form-control form-control-sm" @bind-Value="tempIncre.FechaErogacion" />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small">Importe</label>
                                        <InputNumber class="form-control form-control-sm" @bind-Value="tempIncre.Importe" />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small">Moneda</label>
                                        <InputSelect class="form-select form-select-sm" @bind-Value="tempIncre.TipoMoneda">
                                            <option value="">-- Seleccione --</option>
                                            @foreach (var item in ListaMonedas)
                                            {
                                                <option value="@item.Clave">@item.Clave </option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-success btn-sm w-100" @onclick="AgregarIncrementable">
                                            + Agregar
                                        </button>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <InputCheckbox class="form-check-input" @bind-Value="tempIncre.ACargoImportador" id="checkCargo" />
                                            <label class="form-check-label small" for="checkCargo">¿A cargo del Importador?</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            @if (coveTemporal.Incrementables.Count > 0)
                            {
                                <table class="table table-sm table-bordered table-striped">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Fecha</th>
                                            <th class="text-end">Importe</th>
                                            <th>Moneda</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var inc in coveTemporal.Incrementables)
                                        {
                                            <tr>
                                                <td>@inc.TipoIncrementable</td>
                                                <td>@(inc.FechaErogacion?.ToShortDateString() ?? "-")</td>
                                                <td class="text-end">@inc.Importe.ToString("N2")</td>
                                                <td>@inc.TipoMoneda</td>
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-xs btn-outline-danger" @onclick="() => EliminarIncrementable(inc)">🗑️</button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }
                            else
                            {
                                <p class="text-muted text-center py-4">No has agregado incrementables a este COVE.</p>
                            }
                        </div>

                        <div class="modal-footer mt-3">
                            <button type="button" class="btn btn-secondary" @onclick="CerrarModal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">💾 Guardar COVE en Lista</button>
                        </div>
                    </EditForm>
                </div>

            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int? Id { get; set; }
    // 1. Objeto Principal (La Carpeta)
    private CrearManifestacionDto manifestacion = new CrearManifestacionDto();
    // Esta variable guardará la referencia al objeto original que queremos modificar
    private CoveDetalleDto? coveEnEdicion = null;
    // 2. Control del Modal
    private bool mostrarModal = false;
    private CoveDetalleDto coveTemporal = new CoveDetalleDto();
    private int tabActiva = 1; // 1 = General, 2 = Incrementables
    private IncrementableDto tempIncre = new IncrementableDto();

    // === LISTAS DE CATÁLOGOS (Dinámicas desde BD) ===
    private List<CatalogoDto> ListaIncoterms = new();
    private List<CatalogoDto> ListaMetodosValoracion = new();
    private List<CatalogoDto> ListaFormasPago = new();
    private List<CatalogoDto> ListaMonedas = new(); // Esta la dejaremos estática o la puedes cargar de BD también
    private List<CatalogoDto> ListaIncrementables = new();
    private List<CatalogoDto> ListaDecrementables = new();


    private void AbrirModalNuevo()
    {
        coveEnEdicion = null; // IMPORTANTE: Reseteamos para que sepa que es NUEVO
        coveTemporal = new CoveDetalleDto();
        // Valores por defecto del XML
        coveTemporal.Incoterm = "";
        coveTemporal.MetodoValoracion = "";
        coveTemporal.TipoPago = "";
        coveTemporal.MonedaPago = "";

        // Reiniciamos incrementables
        tempIncre = new IncrementableDto();
        tempIncre.TipoIncrementable = "";
        tempIncre.TipoMoneda = "";
        tabActiva = 1; // Siempre abrir en la primera pestaña

        mostrarModal = true;
    }

    private void CerrarModal() => mostrarModal = false;

    private void GuardarCoveEnLista()
    {
        if (coveEnEdicion != null) // MODO EDICIÓN
        {
            // Buscamos el índice del objeto original en la lista
            var index = manifestacion.Coves.IndexOf(coveEnEdicion);

            if (index != -1)
            {
                // Reemplazamos el viejo con la versión nueva editada
                manifestacion.Coves[index] = coveTemporal;
            }
        }
        else // MODO CREACIÓN (Nuevo)
        {
            manifestacion.Coves.Add(coveTemporal);
        }

        CerrarModal();
    }

    private void EliminarCove(CoveDetalleDto item)
    {
        manifestacion.Coves.Remove(item);
    }

    // Función para agregar un gasto a la tablita interna del modal
    private void AgregarIncrementable()
    {
        if (tempIncre.Importe > 0 && !string.IsNullOrEmpty(tempIncre.TipoIncrementable))
        {
            // Agregamos a la lista del COVE actual
            coveTemporal.Incrementables.Add(tempIncre);

            // Reiniciamos el objeto para permitir agregar otro
            tempIncre = new IncrementableDto();
        }
    }

    private void EliminarIncrementable(IncrementableDto item)
    {
        coveTemporal.Incrementables.Remove(item);
    }

    private async Task GuardarTodo()
    {
        // 1. Validaciones
        if (string.IsNullOrEmpty(manifestacion.ReferenciaAdmin))
        {
            await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "Falta información",
                Text = "El campo 'Referencia / Pedimento' es obligatorio.",
                Icon = SweetAlertIcon.Warning,
                ConfirmButtonText = "Entendido"
            });
            return;
            
        }
        if (manifestacion.Coves.Count == 0)
        {

            await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "¡Atención!",
                Text = "Debe agregar al menos un COVE (Factura) antes de guardar.",
                Icon = SweetAlertIcon.Error,
                ConfirmButtonText = "Corregir"
            });
            return;
        }

        try
        {
            HttpResponseMessage respuesta;

            // 2. DECISIÓN: ¿CREAR O EDITAR?
            if (Id.HasValue)
            {
                // === MODO EDICIÓN (PUT) ===
                respuesta = await Http.PutAsJsonAsync($"api/ManifestacionesValor/{Id}", manifestacion);
            }
            else
            {
                // === MODO CREACIÓN (POST) ===
                respuesta = await Http.PostAsJsonAsync("api/ManifestacionesValor", manifestacion);
            }

            // 3. Procesar Respuesta
            if (respuesta.IsSuccessStatusCode)
            {
                await Swal.FireAsync("¡Guardado!", "El expediente se registró correctamente.", SweetAlertIcon.Success);
                NavManager.NavigateTo("/manifestaciones");
            }
            else
            {
                var error = await respuesta.Content.ReadAsStringAsync();
                await Swal.FireAsync("Error", $"No se pudo guardar: {error}", SweetAlertIcon.Error);
            }
        }
        catch (Exception ex)
        {
            await Swal.FireAsync("Error de Conexión", ex.Message, SweetAlertIcon.Error);
        }
    }

    private void CargarDatosParaEditar(CoveDetalleDto item)
    {
        // 1. Guardamos la referencia del original (para saber a cuál reemplazar luego)
        coveEnEdicion = item;

        // 2. CLONAMOS el objeto usando JSON.
        // ¿Por qué? Para que si modificas el modal pero das "Cancelar",
        // el original en la tabla no se vea afectado.
        var json = JsonSerializer.Serialize(item);
        coveTemporal = JsonSerializer.Deserialize<CoveDetalleDto>(json)!;

        // 3. Reseteamos variables visuales
        tempIncre = new IncrementableDto();
        tabActiva = 1;

        // 4. Abrimos modal
        mostrarModal = true;
    }

    // En NuevaManifestacion.razor

    protected override async Task OnInitializedAsync()
    {
        // 1. Cargar Catálogos en paralelo para que sea rápido
        var t1 = CargarCatalogo("api/catalogos/incoterms", l => ListaIncoterms = l);
        var t2 = CargarCatalogo("api/catalogos/metodos-valoracion", l => ListaMetodosValoracion = l);
        var t3 = CargarCatalogo("api/catalogos/formas-pago", l => ListaFormasPago = l);
        var t4 = CargarCatalogo("api/catalogos/incrementables", l => ListaIncrementables = l);
        var t5 = CargarCatalogo("api/catalogos/decrementables", l => ListaDecrementables = l);

        // Monedas comunes (si no creaste tabla, usamos esta lista manual)
        ListaMonedas = new List<CatalogoDto> {
            new(){ Clave="MXN", Descripcion="MXN - Peso Mexicano"},
            new(){ Clave="USD", Descripcion="USD - Dólar Americano"},
            new(){ Clave="EUR", Descripcion="EUR - Euro"}
        };

        await Task.WhenAll(t1, t2, t3, t4, t5);

        if (Id.HasValue) // Si venimos de "Editar"
        {
            var resultado = await Http.GetFromJsonAsync<ManifestacionDto>($"api/ManifestacionesValor/{Id}");

            if (resultado != null)
            {
                // Mapeo de Cabecera
                manifestacion.ReferenciaAdmin = resultado.NumeroPedimento;
                manifestacion.TipoOperacion = resultado.TipoOperacion;

                // Mapeo de Hijos (COVEs) y Nietos (Incrementables)
                if (resultado.ManifestacionCoves != null)
                {
                    manifestacion.Coves = resultado.ManifestacionCoves.Select(c => new CoveDetalleDto
                    {
                        NumeroCove = c.NumeroCove,
                        NumeroPedimento = c.NumeroPedimento,
                        Incoterm = c.Incoterm,
                        ExisteVinculacion = c.ExisteVinculacion ?? false,
                        // ... otros campos ...
                        TotalValorAduana = c.TotalValorAduana ?? 0,

                        // IMPORTANTE: Recuperar la lista de nietos
                        Incrementables = c.ManifestacionConceptosValor?
                            .Where(x => x.TipoConcepto == "INCREMENTABLE")
                            .Select(i => new IncrementableDto
                            {
                                TipoIncrementable = i.ClaveConcepto,
                                FechaErogacion = i.FechaErogacion ?? DateTime.Now, // Ojo con el nullable
                                Importe = i.Importe,
                                TipoMoneda = i.TipoMoneda,
                                ACargoImportador = i.ACargoImportador ?? false
                            }).ToList() ?? new List<IncrementableDto>()

                    }).ToList();
                }
            }
        }
    }


    // Helper para cargar catálogos y evitar errores si la API falla
    private async Task CargarCatalogo(string url, Action<List<CatalogoDto>> setter)
    {
        try
        {
            var resultado = await Http.GetFromJsonAsync<List<CatalogoDto>>(url);
            if (resultado != null) setter(resultado);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando catálogo {url}: {ex.Message}");
        }
    }

    public class CatalogoDto
    {
        public string Clave { get; set; } = "";
        public string Descripcion { get; set; } = "";
    }
}