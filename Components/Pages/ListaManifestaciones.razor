@page "/manifestaciones"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using SistemaAduanero.Shared.DTOs
@using SistemaAduanero.Shared.DTOs.SistemaAduanero.Shared.DTOs
@inject HttpClient Http
@inject NavigationManager NavManager
@inject SweetAlertService Swal
@attribute [Authorize]

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-0 fw-bold text-primary">Expedientes de Valor</h3>
            <p class="text-muted small">Listado de manifestaciones registradas</p>
        </div>
        @if (!bloquearCamposAA) 
          {
            <button class="btn btn-primary" @onclick="IrANueva">
                <i class="bi bi-plus-lg"></i> Nuevo Expediente
            </button>
          }
    </div>

    <div class="card shadow-sm border-0 mb-4 bg-light">
        <div class="card-body py-3">
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Fecha Inicio</label>
                    <input type="date" class="form-control form-control-sm" @bind="filtros.FechaInicio" />
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Fecha Fin</label>
                    <input type="date" class="form-control form-control-sm" @bind="filtros.FechaFin" />
                </div>
                <div class="col-md-4">
                    <label class="form-label small fw-bold text-muted">Buscar por pedimento /cliente / referencia</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" placeholder="Ej: 5000001 .. o Nombre Cliente" @bind="filtros.BusquedaTexto" @bind:event="oninput" @onkeyup="@(e => { if (e.Key == "Enter") CargarDatos(1); })" />
                    </div>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary btn-sm w-100 fw-bold" @onclick="() => CargarDatos(1)">
                        FILTRAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (respuesta == null)
    {
        <div class="d-flex justify-content-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    }
    else if (respuesta.Elementos.Count == 0)
    {
        <div class="alert alert-info text-center shadow-sm border-0">
            <i class="bi bi-folder2-open fs-1 d-block mb-2"></i>
            <strong>No se encontraron resultados.</strong>
            <p class="mb-0 mt-2">Intenta ajustar los filtros o registra un nuevo expediente.</p>
        </div>
    }
    else
    {
        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light small text-uppercase">
                            <tr>
                                <th>Referencia</th>
                                 <th class="ps-4">Pedimento</th>
                                <th>Cliente</th>
                                <th class="text-end">Valor Aduana</th>
                                <th class="text-center">Estado</th>
                                <th class="text-center">Fecha Registro</th>
                                <th class="text-end pe-4">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @* NOTA: Ahora iteramos sobre respuesta.Elementos, no sobre la variable directa *@
                            @foreach (var item in respuesta.Elementos)
                            {
                                <tr>
                                    
                                    <td class="ps-4 fw-bold text-primary">
                                        @if (!string.IsNullOrEmpty(item.Referencia))
                                        {
                                             @item.Referencia
                                        }
                                        else
                                        {
                                            <span class="text-muted small">Sin referencia</span>
                                        }
                                    </td>
                                    <td class="ps-4 fw-bold text-primary">@item.NumeroPedimento</td>
                                    <td class="ps-4 fw-bold text-primary">  @item.RazonSocial </td>

                                    <td class="text-end fw-bold">
                                        @((item.TotalValorAduana ?? 0).ToString("C2"))
                                    </td>
                                    <td class="text-center">
                                        @if (item.EstadoEnvio == "COMPLETO")
                                        {
                                            <span class="badge bg-success">Completo</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Borrador</span>
                                        }
                                    </td>
                                    <td class="text-center small text-muted">
                                        @item.FechaRegistro?.ToShortDateString()
                                    </td>
                                    <td class="text-end pe-4">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => Editar(item.ManifestacionId)" title="Editar">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => Eliminar(item)" title="Eliminar">
                                                <i class="bi bi-trash3"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-footer bg-white py-3 border-top-0 d-flex justify-content-between align-items-center">
                <small class="text-muted">Mostrando @respuesta.Elementos.Count registros de <strong>@respuesta.TotalRegistros</strong> encontrados.</small>

                <nav aria-label="Page navigation">
                    <ul class="pagination pagination-sm mb-0">
                        @* Botón Anterior *@
                        <li class="page-item @(filtros.Pagina == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => CargarDatos(filtros.Pagina - 1)">Anterior</button>
                        </li>

                        @* Indicador de Página *@
                        <li class="page-item disabled">
                            <span class="page-link bg-light text-dark border-0 mx-2">
                                Página @filtros.Pagina de @respuesta.TotalPaginas
                            </span>
                        </li>

                        @* Botón Siguiente *@
                        <li class="page-item @(filtros.Pagina >= respuesta.TotalPaginas ? "disabled" : "")">
                            <button class="page-link" @onclick="() => CargarDatos(filtros.Pagina + 1)">Siguiente</button>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    }
</div>

@code {
    //seguridad de campos
    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; }
    private bool bloquearCamposAA = false;

    // 1. Objeto para guardar los filtros que el usuario escribe
    private PaginacionRequestDto filtros = new PaginacionRequestDto();

    // 2. Objeto para recibir la respuesta PAGINADA (Lista + Metadatos)
    // NOTA: Ya no usamos List<ManifestacionDto> directamente
    private PaginacionResponseDto<ManifestacionDto>? respuesta;

    protected override async Task OnInitializedAsync()
    {
        //configuracion de seguridad
        var authState = await AuthStateTask;
        var user = authState.User;

        // Si es Cliente, activamos el bloqueo
        if (user.IsInRole("Cliente"))
        {
            bloquearCamposAA = true;
        }
        // Configuración inicial: Mostrar últimos 30 días o semana
        filtros.FechaInicio = DateTime.Today.AddDays(-5);
        filtros.FechaFin = DateTime.Today;

        await CargarDatos(1);
    }

    private async Task CargarDatos(int pagina)
    {
        try
        {
            filtros.Pagina = pagina;

            // 3. Construimos la URL con Query Strings para enviar los filtros al Controller
            // Ejemplo: api/ManifestacionesValor?Pagina=1&RegistrosPorPagina=10&FechaInicio=2024-01-01...
            var query = new List<string>
            {
                $"Pagina={filtros.Pagina}",
                $"RegistrosPorPagina={filtros.RegistrosPorPagina}"
            };

            if (filtros.FechaInicio.HasValue)
                query.Add($"FechaInicio={filtros.FechaInicio.Value:yyyy-MM-dd}");

            if (filtros.FechaFin.HasValue)
                query.Add($"FechaFin={filtros.FechaFin.Value:yyyy-MM-dd}");

            if (!string.IsNullOrEmpty(filtros.BusquedaTexto))
                query.Add($"BusquedaTexto={filtros.BusquedaTexto}");

            var url = $"api/ManifestacionesValor?{string.Join("&", query)}";

            // 4. Hacemos la petición esperando el DTO de Paginación
            respuesta = await Http.GetFromJsonAsync<PaginacionResponseDto<ManifestacionDto>>(url);
        }
        catch (Exception ex)
        {
            await MostrarToast("Error: No se pudieron cargar los datos: " + ex.Message, SweetAlertIcon.Error);
        }
    }

    private void IrANueva()
    {
        NavManager.NavigateTo("/manifestaciones/nueva");
    }

    private void Editar(int id)
    {
        NavManager.NavigateTo($"/manifestaciones/editar/{id}");
    }

    private async Task Eliminar(ManifestacionDto item)
    {
        var confirm = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "¿Estás seguro?",
            Text = $"Se eliminará el expediente {item.NumeroPedimento}.",
            Icon = SweetAlertIcon.Warning,
            ShowCancelButton = true,
            ConfirmButtonText = "Sí, eliminar",
            CancelButtonText = "Cancelar"
        });

        if (confirm.IsConfirmed)
        {
            var res = await Http.DeleteAsync($"api/ManifestacionesValor/{item.ManifestacionId}");
            if (res.IsSuccessStatusCode)
            {
                await MostrarToast("Registro eliminado.", SweetAlertIcon.Success);
                // Recargamos la misma página donde estábamos
                await CargarDatos(filtros.Pagina);
            }
            else
            {
                await MostrarToast("No se pudo eliminar.", SweetAlertIcon.Error);
            }
        }
    }

    private async Task MostrarToast(string mensaje, SweetAlertIcon icono)
    {
        await Swal.FireAsync(new SweetAlertOptions
        {
            Toast = true,
            Position = SweetAlertPosition.TopEnd, // Arriba a la derecha
            ShowConfirmButton = false,
            Timer = 3000,
            Icon = icono,
            Title = mensaje
        });
    }
}