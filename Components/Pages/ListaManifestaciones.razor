@page "/manifestaciones"
@using SistemaAduanero.Web.Models
@inject SweetAlertService Swal

@using Microsoft.AspNetCore.Authorization
@inject HttpClient Http
@inject IJSRuntime JsRuntime
@rendermode InteractiveServer
@attribute [Authorize]

<div class="container mt-4">
    
    <h3> <i class="bi bi-card-list"></i> Listado de Manifestaciones de Valor</h3>
    <p class="text-muted">Gestión de trámites aduaneros VUCEM</p>

    <div class="text-end mb-3">
        <a href="manifestaciones/nueva" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Nueva
        </a>
    </div>


    @if (manifestaciones == null)
    {
        <p><em>Cargando pedimentos...</em></p>
    }
    else if (!manifestaciones.Any())
    {
        <div class="alert alert-info">No hay manifestaciones registradas aún.</div>
    }
    else
    {
        <table class="table table-striped table-hover shadow-sm">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Pedimento</th>
                    <th>COVE</th>
                    <th>Valor Aduana</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in manifestaciones)
                {
                    <tr>
                        <td>@item.ManifestacionId</td>
                        <td>@item.NumeroPedimento</td>
                        <td>@item.Cove</td>
                        <td>
                            @item.TotalValorAduana.ToString("C2", System.Globalization.CultureInfo.CreateSpecificCulture("es-MX"))
                        </td>
                        <td>
                            <span class="badge @(item.EstadoEnvio == "BORRADOR" ? "bg-warning" : "bg-success")">
                                @item.EstadoEnvio
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group" role="group">

                                <a href="manifestaciones/editar/@item.ManifestacionId" class="btn btn-outline-primary btn-sm" title="Editar Expediente">
                                    <i class="bi bi-pencil-square"></i>
                                </a>

                                <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => EliminarManifestacion(item.ManifestacionId)" title="Eliminar Expediente">
                                    <i class="bi bi-trash3-fill"></i>
                                </button>

                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    private List<ManifestacionDto>? manifestaciones;

    protected override async Task OnInitializedAsync()
    {
        await CargarManifestaciones();
    }

    private async Task CargarManifestaciones()
    {
        try
        {
            // Ajusta la ruta si tu API tiene otro nombre
            manifestaciones = await Http.GetFromJsonAsync<List<ManifestacionDto>>("api/ManifestacionesValor");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar: {ex.Message}");
        }
    }

    private async Task EliminarManifestacion(int id)
    {
        // 1. Confirmación sencilla con JavaScript (opcional)
        //bool confirmado = await JsRuntime.InvokeAsync<bool>("confirm", "¿Estás seguro de eliminar este expediente? Se borrarán también sus COVEs.");

        // 1. Recibes el objeto completo (NO es un bool todavía)
       

        var resultado = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "Advertencia",
            Text = "¿Estás seguro de eliminar este expediente? Se borrarán también sus COVEs.",
            Icon = SweetAlertIcon.Warning,
            ShowCancelButton = true,
            CancelButtonColor = "#d33",
            CancelButtonText= "Cancelar",
            ConfirmButtonText = "Confirmar"
        });
        bool confirmado = resultado.IsConfirmed;

        if (confirmado)
        {
            try
            {
                // 2. Llamada a la API (Necesitas crear este Endpoint en el Controller si no existe)
                var respuesta = await Http.DeleteAsync($"api/ManifestacionesValor/{id}");

                if (respuesta.IsSuccessStatusCode)
                {
                    // 3. Recargar la lista visualmente
                    await CargarManifestaciones();
                }
                else
                {
                    // Manejo de error sencillo
                    Console.WriteLine("No se pudo eliminar.");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error: {ex.Message}");
            }
        }
    }
}